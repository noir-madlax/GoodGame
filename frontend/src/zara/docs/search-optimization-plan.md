# ZARA 智能搜索优化方案 - 实施指南

## 文档信息

| 项目     | 说明                                        |
| -------- | ------------------------------------------- |
| 版本     | v1.0                                        |
| 创建日期 | 2025-12-12                                  |
| 适用范围 | ZARA 商品智能搜索系统                       |
| 目标     | 提升搜索精准度，实现 APUS 语义匹配 + 硬过滤 |

---

## 一、项目背景与目标

### 1.1 当前问题

| 问题            | 具体表现                           | 影响程度 |
| --------------- | ---------------------------------- | -------- |
| APUS 匹配不精准 | 使用关键词文本匹配，无法理解同义词 | 高       |
| 无性别过滤      | 搜索"女装裙子"可能返回童装/男装    | 严重     |
| 品类过滤不严格  | 品类只作为加权因子，非硬过滤       | 严重     |
| 性别数据缺失    | 商品表中无性别字段                 | 高       |

### 1.2 优化目标

1. **精准性**：搜索结果必须符合用户指定的性别和品类
2. **语义理解**：APUS 四维度使用向量语义匹配，理解同义词
3. **可解释性**：Debug 信息清晰展示各维度得分和过滤逻辑

---

## 二、核心架构设计

### 2.1 搜索流程总览

```
┌──────────────────────────────────────────────────────────────────────────┐
│                           用户输入                                        │
│                    "宽松休闲的女装牛仔裤"                                   │
└──────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                      阶段一：LLM 意图解析                                  │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │ 输出结构：                                                          │  │
│  │ {                                                                  │  │
│  │   "hardFilters": {                                                 │  │
│  │     "gender": "女装",           // 性别过滤条件                      │  │
│  │     "category": "牛仔裤"        // 品类过滤条件                      │  │
│  │   },                                                               │  │
│  │   "intentAnalysis": {                                              │  │
│  │     "attribute": "宽松、阔腿、休闲版型",                              │  │
│  │     "performance": "舒适、不紧绷、易搭配",                           │  │
│  │     "use": "日常休闲、逛街",                                        │  │
│  │     "style": "休闲风、简约"                                         │  │
│  │   }                                                                │  │
│  │ }                                                                  │  │
│  └────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                    阶段二：语义硬过滤（LLM 判断）                           │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │ 方式：LLM 向量语义匹配（非文本精确匹配）                               │  │
│  │                                                                    │  │
│  │ 用户意图 gender: "女装"                                             │  │
│  │ 商品 gender: "女士"  → LLM判断语义一致 → ✓ 通过                      │  │
│  │ 商品 gender: "女童"  → LLM判断语义不一致 → ✗ 排除                    │  │
│  │ 商品 gender: "淑女"  → LLM判断语义一致 → ✓ 通过                      │  │
│  │                                                                    │  │
│  │ 注：避免"女"字的简单文本匹配导致误判                                  │  │
│  └────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                    阶段三：APUS 向量语义搜索                               │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │ 五路并行向量搜索：                                                   │  │
│  │                                                                    │  │
│  │ 1. 综合向量搜索 (text_enhanced_embedding)                           │  │
│  │    用户增强搜索文本 ↔ 商品增强描述文本                                │  │
│  │                                                                    │  │
│  │ 2. 属性向量搜索 (attribute_embedding)                               │  │
│  │    用户属性意图 ↔ 商品属性关键词                                     │  │
│  │                                                                    │  │
│  │ 3. 性能向量搜索 (performance_embedding)                             │  │
│  │    用户性能意图 ↔ 商品性能关键词                                     │  │
│  │                                                                    │  │
│  │ 4. 场景向量搜索 (use_embedding)                                     │  │
│  │    用户场景意图 ↔ 商品场景关键词                                     │  │
│  │                                                                    │  │
│  │ 5. 风格向量搜索 (style_embedding)                                   │  │
│  │    用户风格意图 ↔ 商品风格关键词                                     │  │
│  └────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                      阶段四：加权排序                                      │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │ 最终得分 =                                                          │  │
│  │   text_enhanced_score × 综合权重                                    │  │
│  │ + attribute_score × 属性权重                                        │  │
│  │ + performance_score × 性能权重                                      │  │
│  │ + use_score × 场景权重                                              │  │
│  │ + style_score × 风格权重                                            │  │
│  │                                                                    │  │
│  │ 权重总和 = 1.0                                                      │  │
│  └────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────┘
```

### 2.2 关键设计决策

| 决策点            | 方案选择                   | 原因                          |
| ----------------- | -------------------------- | ----------------------------- |
| 性别/品类过滤方式 | LLM 语义判断（非文本匹配） | 避免"女童"和"女装"的误匹配    |
| APUS 匹配方式     | 向量语义搜索               | 理解同义词                    |
| 向量模型          | `text-embedding-3-small` | 与现有 text_enhanced 保持一致 |
| 过滤时机          | 搜索前硬过滤               | 减少无效计算，提升性能        |

---

## 三、商品数据处理方案

### 3.1 数据处理流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        商品原始数据                                       │
│  - 商品名称                                                              │
│  - 商品图片                                                              │
│  - 商品分类                                                              │
│  - 商品描述                                                              │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    步骤一：LLM 商品理解                                    │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ 输入：商品名称 + 图片 + 描述                                        │  │
│  │ 输出：                                                             │  │
│  │ {                                                                 │  │
│  │   "gender": "女装",              // 从商品信息解析                   │  │
│  │   "category": "牛仔裤",          // 品类分类                        │  │
│  │   "attribute_keywords": [...],   // 属性关键词数组                  │  │
│  │   "performance_keywords": [...], // 性能关键词数组                  │  │
│  │   "use_keywords": [...],         // 场景关键词数组                  │  │
│  │   "style_keywords": [...],       // 风格关键词数组                  │  │
│  │   "text_enhanced": "..."         // 增强描述文本                    │  │
│  │ }                                                                 │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    步骤二：向量化                                          │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ 使用模型：text-embedding-3-small（必须与搜索模型一致）               │  │
│  │                                                                   │  │
│  │ 向量化内容：                                                        │  │
│  │ 1. text_enhanced → text_enhanced_embedding                        │  │
│  │ 2. attribute_keywords.join(' ') → attribute_embedding             │  │
│  │ 3. performance_keywords.join(' ') → performance_embedding         │  │
│  │ 4. use_keywords.join(' ') → use_embedding                         │  │
│  │ 5. style_keywords.join(' ') → style_embedding                     │  │
│  │                                                                   │  │
│  │ 向量维度：1536                                                     │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                    步骤三：数据入库                                        │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ gg_taobao_product 表：                                             │  │
│  │   - gender (新增)                                                  │  │
│  │   - category                                                       │  │
│  │                                                                   │  │
│  │ gg_taobao_product_apu 表：                                         │  │
│  │   - attribute_keywords                                             │  │
│  │   - performance_keywords                                           │  │
│  │   - use_keywords                                                   │  │
│  │   - style_keywords                                                 │  │
│  │   - text_enhanced                                                  │  │
│  │                                                                   │  │
│  │ gg_taobao_product_embeddings 表：                                  │  │
│  │   - text_enhanced_embedding (已有)                                 │  │
│  │   - attribute_embedding (新增)                                     │  │
│  │   - performance_embedding (新增)                                   │  │
│  │   - use_embedding (新增)                                           │  │
│  │   - style_embedding (新增)                                         │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
```

### 3.2 商品 LLM 理解的必须输出字段

| 字段                     | 类型     | 必须 | 说明                           |
| ------------------------ | -------- | ---- | ------------------------------ |
| `gender`               | string   | ✅   | 性别分类：女装/男装/童装/中性  |
| `category`             | string   | ✅   | 品类：连衣裙/牛仔裤/T恤等      |
| `attribute_keywords`   | string[] | ✅   | 属性关键词：宽松、高腰、阔腿等 |
| `performance_keywords` | string[] | ✅   | 性能关键词：透气、显瘦、防晒等 |
| `use_keywords`         | string[] | ✅   | 场景关键词：通勤、约会、度假等 |
| `style_keywords`       | string[] | ✅   | 风格关键词：复古、简约、甜美等 |
| `text_enhanced`        | string   | ✅   | 增强描述文本（整合以上信息）   |

### 3.3 性别解析规则

**输入来源**：商品名称 + 商品分类 + 商品图片

**解析逻辑**（由 LLM 执行）：

| 输入特征                                 | 解析结果         |
| ---------------------------------------- | ---------------- |
| 包含"女"、"女士"、"女款"、"淑女"、"lady" | 女装             |
| 包含"男"、"男士"、"男款"、"gentleman"    | 男装             |
| 包含"童"、"儿童"、"小孩"、"kids"、"baby" | 童装             |
| 无明显性别特征                           | 中性             |
| 图片显示女性模特                         | 女装（辅助判断） |

**重要**：最终判断由 LLM 综合所有信息给出，非简单文本匹配

---

## 四、数据库结构变更

### 4.1 表结构变更清单

| 表名                             | 变更类型 | 字段                      | 类型             | 说明     |
| -------------------------------- | -------- | ------------------------- | ---------------- | -------- |
| `gg_taobao_product`            | 新增字段 | `gender`                | `text`         | 性别分类 |
| `gg_taobao_product_embeddings` | 新增字段 | `attribute_embedding`   | `vector(1536)` | 属性向量 |
| `gg_taobao_product_embeddings` | 新增字段 | `performance_embedding` | `vector(1536)` | 性能向量 |
| `gg_taobao_product_embeddings` | 新增字段 | `use_embedding`         | `vector(1536)` | 场景向量 |
| `gg_taobao_product_embeddings` | 新增字段 | `style_embedding`       | `vector(1536)` | 风格向量 |

### 4.2 索引变更清单

| 表名                             | 索引类型 | 字段                      | 说明         |
| -------------------------------- | -------- | ------------------------- | ------------ |
| `gg_taobao_product`            | btree    | `gender`                | 性别过滤索引 |
| `gg_taobao_product_embeddings` | ivfflat  | `attribute_embedding`   | 属性向量索引 |
| `gg_taobao_product_embeddings` | ivfflat  | `performance_embedding` | 性能向量索引 |
| `gg_taobao_product_embeddings` | ivfflat  | `use_embedding`         | 场景向量索引 |
| `gg_taobao_product_embeddings` | ivfflat  | `style_embedding`       | 风格向量索引 |

---

## 五、语义硬过滤设计

### 5.1 为什么不能用文本匹配

| 用户输入 | 商品标签 | 文本匹配结果    | 语义匹配结果        |
| -------- | -------- | --------------- | ------------------- |
| 女装     | 女士     | ❌ 不匹配       | ✅ 匹配             |
| 女装     | 女童     | ❌ 错误匹配"女" | ✅ 不匹配           |
| 女装     | 淑女风   | ❌ 不匹配       | ✅ 匹配             |
| 牛仔裤   | 牛仔短裤 | ❌ 模糊         | ✅ 匹配（同品类）   |
| 连衣裙   | 吊带裙   | ❌ 不匹配       | ✅ 匹配（裙装子类） |

### 5.2 语义过滤实现方式

**方案**：使用向量相似度进行语义判断

```
用户 gender 意图: "女装"  → 向量化 → query_gender_vector
商品 gender 标签: "女士"  → 向量化 → product_gender_vector

相似度 = cosine_similarity(query_gender_vector, product_gender_vector)

if 相似度 > 阈值(0.8):
    通过过滤
else:
    排除
```

**阈值设定**：

- 性别过滤阈值：0.85（严格）
- 品类过滤阈值：0.75（允许子品类）

### 5.3 性别分类体系

```
性别分类：
├── 女装
│   ├── 女士
│   ├── 女款
│   ├── 淑女
│   └── lady
├── 男装
│   ├── 男士
│   ├── 男款
│   └── gentleman
├── 童装
│   ├── 女童
│   ├── 男童
│   ├── 儿童
│   └── kids
└── 中性
    ├── 无性别标识
    └── 通用款
```

---

## 六、向量模型一致性要求

### 6.1 模型使用规范

| 场景                      | 模型                       | 维度 | 必须一致 |
| ------------------------- | -------------------------- | ---- | -------- |
| 商品 text_enhanced 向量化 | `text-embedding-3-small` | 1536 | ✅       |
| 商品 APUS 四维度向量化    | `text-embedding-3-small` | 1536 | ✅       |
| 搜索时用户意图向量化      | `text-embedding-3-small` | 1536 | ✅       |
| 性别/品类语义判断         | `text-embedding-3-small` | 1536 | ✅       |

### 6.2 一致性检查点

在实施过程中必须确认：

- [ ] 所有向量化调用使用同一个 embedding API endpoint
- [ ] 所有向量化调用使用同一个模型名称 `text-embedding-3-small`
- [ ] 所有存储的向量维度为 1536
- [ ] 搜索时的向量化与入库时的向量化使用相同配置

---

## 七、搜索权重配置

### 7.1 权重配置结构

```json
{
  "vectorWeights": {
    "text_enhanced": 0.3,    // 综合向量权重
    "attribute": 0.2,        // 属性向量权重
    "performance": 0.2,      // 性能向量权重
    "use": 0.15,             // 场景向量权重
    "style": 0.15            // 风格向量权重
  },
  "filterThresholds": {
    "gender": 0.85,          // 性别过滤阈值
    "category": 0.75         // 品类过滤阈值
  }
}
```

### 7.2 权重约束

- `vectorWeights` 所有权重之和必须 = 1.0
- 所有权重值范围：0.0 ~ 1.0
- 阈值范围：0.5 ~ 1.0

---

## 八、实施步骤

### Phase 1：数据库准备

| 步骤 | 内容                             | 产出         |
| ---- | -------------------------------- | ------------ |
| 1.1  | 新增 `gender` 字段到商品表     | DDL 执行完成 |
| 1.2  | 新增 4 个 embedding 字段到向量表 | DDL 执行完成 |
| 1.3  | 创建必要索引                     | 索引创建完成 |

### Phase 2：商品数据补充

| 步骤 | 内容                       | 产出                     |
| ---- | -------------------------- | ------------------------ |
| 2.1  | 编写商品 gender 解析脚本   | 脚本文件                 |
| 2.2  | 运行解析，填充 gender 字段 | 292 条商品 gender 已填充 |
| 2.3  | 人工抽检验证准确性         | 抽检报告                 |

### Phase 3：APUS 向量化

| 步骤 | 内容                                      | 产出                   |
| ---- | ----------------------------------------- | ---------------------- |
| 3.1  | 编写 APUS 四维度向量化脚本                | 脚本文件               |
| 3.2  | 运行向量化（使用 text-embedding-3-small） | 4 × 292 = 1168 个向量 |
| 3.3  | 验证向量维度和存储                        | 验证报告               |

### Phase 4：搜索 API 改造

| 步骤 | 内容                              | 产出            |
| ---- | --------------------------------- | --------------- |
| 4.1  | 修改 LLM Prompt，输出 hardFilters | Prompt 模板更新 |
| 4.2  | 实现语义硬过滤逻辑                | 过滤函数        |
| 4.3  | 实现 APUS 五路向量搜索            | 搜索函数        |
| 4.4  | 实现加权排序逻辑                  | 排序函数        |

### Phase 5：前端更新

| 步骤 | 内容                | 产出                 |
| ---- | ------------------- | -------------------- |
| 5.1  | 更新权重配置页面    | 新的权重配置 UI      |
| 5.2  | 更新 Debug 信息展示 | 详细的各维度得分展示 |
| 5.3  | 集成测试            | 测试报告             |

---

## 九、验收标准

### 9.1 功能验收

| 测试场景               | 预期结果                               |
| ---------------------- | -------------------------------------- |
| 搜索"女装连衣裙"       | 只返回女装，不返回童装/男装            |
| 搜索"宽松休闲的牛仔裤" | 只返回牛仔裤品类，不返回 T恤           |
| 搜索"凉快透气的裙子"   | 能匹配"透气面料"、"清凉"等语义相近商品 |
| 搜索"约会穿的连衣裙"   | 场景维度得分高的排在前面               |

### 9.2 技术验收

| 检查项         | 标准                                       |
| -------------- | ------------------------------------------ |
| 向量模型一致性 | 所有 embedding 使用 text-embedding-3-small |
| 向量维度       | 所有向量维度为 1536                        |
| 权重配置       | 可通过 UI 调整，实时生效                   |
| Debug 信息     | 显示各维度得分、过滤结果、最终排序         |

### 9.3 性能验收

| 指标         | 标准                  |
| ------------ | --------------------- |
| 搜索响应时间 | < 3 秒（含 LLM 解析） |
| 向量化时间   | 单商品 < 2 秒         |
| 过滤准确率   | 性别/品类过滤 > 95%   |

---

## 十、关键风险与应对

| 风险             | 影响             | 应对措施                            |
| ---------------- | ---------------- | ----------------------------------- |
| 向量模型不一致   | 搜索结果完全不准 | 代码 Review 检查所有 embedding 调用 |
| 性别解析不准     | 过滤失效         | LLM Prompt 优化 + 人工抽检          |
| 语义阈值设置不当 | 过滤过严或过松   | 提供可配置阈值，支持调优            |
| 向量化脚本失败   | 数据不完整       | 增加重试机制和进度记录              |

---

## 十一、后续优化方向

1. **品类层级结构**：建立品类树（服装 > 裙装 > 连衣裙 > 吊带连衣裙）
2. **属性关联图谱**：建立同义词/近义词映射
3. **用户反馈学习**：根据点击/购买调整权重
4. **多模态搜索**：支持图片搜索（以图搜图）

---

## 十二、附录：核心约束清单

### 必须遵守的约束

| 约束项         | 说明                                               | 违反后果            |
| -------------- | -------------------------------------------------- | ------------------- |
| 向量模型一致性 | 所有 embedding 必须使用 `text-embedding-3-small` | 搜索结果完全错误    |
| 向量维度       | 必须为 1536                                        | 数据库存储/查询失败 |
| 性别必须解析   | 每个商品必须有 gender 字段                         | 性别过滤失效        |
| 品类必须解析   | 每个商品必须有 category 字段                       | 品类过滤失效        |
| 权重总和为 1   | vectorWeights 各项相加必须等于 1.0                 | 得分计算错误        |

### 商品数据必须包含字段

- `gender` - 性别分类
- `category` - 品类分类
- `attribute_keywords` - 属性关键词数组
- `performance_keywords` - 性能关键词数组
- `use_keywords` - 场景关键词数组
- `style_keywords` - 风格关键词数组
- `text_enhanced` - 增强描述文本
- `text_enhanced_embedding` - 增强描述向量
- `attribute_embedding` - 属性向量
- `performance_embedding` - 性能向量
- `use_embedding` - 场景向量
- `style_embedding` - 风格向量

---

**文档版本**: v1.0
**最后更新**: 2025-12-12
**负责人**: AI Agent
