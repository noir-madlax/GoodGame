# 数据库结构与报告字段对应说明

## 一、数据表概览

### 1.1 原始数据表（API 数据存储）

| 表名 | 说明 | 数据来源 |
|------|------|----------|
| `gg_pgy_kol_base_info` | KOL 基础信息 | kol_info API |
| `gg_pgy_kol_fans_trend` | 粉丝趋势（30天每日） | kol_fans_trend API |
| `gg_pgy_kol_fans_summary` | 粉丝汇总 | kol_fans_summary API |
| `gg_pgy_kol_note_rate` | 笔记数据表现 | kol_note_rate API |
| `gg_pgy_kol_notes` | 笔记列表 | kol_note_list API |
| `gg_pgy_kol_core_data` | 核心数据（30天每日） | kol_core_data API |
| `gg_pgy_kol_cost_effective` | 性价比数据 | kol_cost_effective API |
| `gg_pgy_kol_audience` | 粉丝画像 | kol_fans_portrait API |

### 1.2 分析结果表

| 表名 | 说明 |
|------|------|
| `gg_pgy_kol_analysis_result` | 分析结果汇总（所有需求的分析结果） |

---

## 二、分析结果表字段详解

### 2.1 表结构：`gg_pgy_kol_analysis_result`

```sql
-- 主键和标识
id                          -- 自增主键
kol_id                      -- KOL ID（与其他表关联）
kol_name                    -- KOL 名称
project_name                -- 项目名称（如"枕头分析"）

-- 需求1: 粉丝增长趋势
fans_count_current          -- 当前粉丝数
fans_count_30d_ago          -- 30天前粉丝数
fans_growth_30d             -- 30天增长数
fans_growth_rate_30d        -- 30天增长率 (%)
fans_trend_status           -- 趋势状态: rising/stable/declining
fans_trend_detail           -- JSONB: 详细数据（每日粉丝、正负天数、波动性等）

-- 需求2&7: 发帖频率
post_count_30d              -- 30天发帖数
post_avg_per_week           -- 平均每周发帖数
post_frequency_pass         -- 是否达标（>3篇/周）
post_frequency_detail       -- JSONB: 每周发帖详情
active_days_7d              -- 近7天活跃天数 ✅ 新增

-- 需求3: 阅读/点赞/评论数据
read_median                 -- 阅读中位数
read_avg                    -- 阅读平均值
like_median                 -- 点赞中位数
like_avg                    -- 点赞平均值
collect_median              -- 收藏中位数
collect_avg                 -- 收藏平均值
comment_median              -- 评论中位数
comment_avg                 -- 评论平均值
interaction_median          -- 互动中位数
interaction_avg             -- 互动平均值
read_beyond_rate            -- 阅读中位数超越同行比例 ✅ 新增
interaction_beyond_rate     -- 互动中位数超越同行比例 ✅ 新增

-- 需求4: 粉丝 vs 数据比例
read_fans_ratio_avg         -- 阅读/粉丝比例平均值
read_fans_ratio_pass        -- 是否达标（>30%）
read_fans_ratio_pass_count  -- 达标笔记数
note_count_30d              -- 30天内笔记总数 ✅ 新增
comment_gt_20_count         -- 评论>20条的笔记数
comment_gt_20_pass          -- 是否有评论>20条的笔记
comment_max                 -- 单篇评论最高数 ✅ 新增

-- 需求5: 爆文情况
hot_note_count              -- 爆文数量
hot_note_pass               -- 是否达标（>1篇）
hot_note_threshold          -- 爆文阈值（互动中位数×3）
hot_note_detail             -- JSONB: 爆文列表

-- 需求6: 互动趋势
interaction_trend_status    -- 互动趋势: rising/stable/declining
interaction_trend_detail    -- JSONB: 每日互动数据
daily_imp_avg               -- 30天日均曝光 ✅ 新增
daily_read_avg              -- 30天日均阅读 ✅ 新增
daily_engage_avg            -- 30天日均互动 ✅ 新增

-- 综合
overall_score               -- 综合评分（可选）
recommendation              -- 推荐建议
analysis_notes              -- 分析备注

-- 元数据
analysis_date               -- 分析时间
data_source                 -- 数据来源
created_at                  -- 创建时间
updated_at                  -- 更新时间
```

---

## 三、报告字段与数据库对应关系

### 3.1 需求1：粉丝增长趋势

| 报告字段 | 数据库字段 | 类型 | 说明 |
|----------|-----------|------|------|
| 当前粉丝数 | `fans_count_current` | bigint | 直接取值 |
| 30天前粉丝数 | `fans_count_30d_ago` | bigint | 直接取值 |
| 30天增长数 | `fans_growth_30d` | integer | 直接取值 |
| 30天增长率 | `fans_growth_rate_30d` | numeric | 直接取值 |
| 趋势状态 | `fans_trend_status` | text | rising/stable/declining |
| 增长排名 | - | - | SQL 查询计算 |
| 正增长天数 | `fans_trend_detail->>'positive_days'` | jsonb | 从 detail 提取 |
| 负增长天数 | `fans_trend_detail->>'negative_days'` | jsonb | 从 detail 提取 |
| 日均增长 | `fans_trend_detail->>'avg_daily_change'` | jsonb | 从 detail 提取 |
| 超越同行 | `fans_trend_detail->>'beyond_rate'` | jsonb | 从 detail 提取 |
| 每日数据 | `fans_trend_detail->'daily_data'` | jsonb | 从 detail 提取 |

### 3.2 需求2&7：发帖频率

| 报告字段 | 数据库字段 | 类型 | 说明 |
|----------|-----------|------|------|
| 30天发帖数 | `post_count_30d` | integer | 直接取值 |
| 平均每周发帖 | `post_avg_per_week` | numeric | 直接取值 |
| 是否达标 | `post_frequency_pass` | boolean | true/false |
| 每周详情 | `post_frequency_detail` | jsonb | 从 detail 提取 |
| **近7天活跃天数** | `active_days_7d` | integer | 直接取值 ✅ |

### 3.3 需求3：数据表现

| 报告字段 | 数据库字段 | 类型 | 说明 |
|----------|-----------|------|------|
| 阅读中位数 | `read_median` | integer | 直接取值 |
| 阅读平均值 | `read_avg` | numeric | 直接取值 |
| 点赞中位数 | `like_median` | integer | 直接取值 |
| 点赞平均值 | `like_avg` | numeric | 直接取值 |
| 收藏中位数 | `collect_median` | integer | 直接取值 |
| 收藏平均值 | `collect_avg` | numeric | 直接取值 |
| 评论中位数 | `comment_median` | integer | 直接取值 |
| 评论平均值 | `comment_avg` | numeric | 直接取值 |
| 互动中位数 | `interaction_median` | integer | 直接取值 |
| 互动平均值 | `interaction_avg` | numeric | 直接取值 |
| **阅读中位数超越同行** | `read_beyond_rate` | numeric | 直接取值 ✅ |
| **互动中位数超越同行** | `interaction_beyond_rate` | numeric | 直接取值 ✅ |

### 3.4 需求4：粉丝 vs 数据比例

| 报告字段 | 数据库字段 | 类型 | 说明 |
|----------|-----------|------|------|
| 阅读/粉丝比例 | `read_fans_ratio_avg` | numeric | 直接取值 |
| 是否达标(>30%) | `read_fans_ratio_pass` | boolean | true/false |
| 达标笔记数 | `read_fans_ratio_pass_count` | integer | 直接取值 |
| **30天内笔记总数** | `note_count_30d` | integer | 直接取值 ✅ |
| 评论>20条数 | `comment_gt_20_count` | integer | 直接取值 |
| 是否有评论>20 | `comment_gt_20_pass` | boolean | true/false |
| **评论最高笔记数** | `comment_max` | integer | 直接取值 ✅ |

### 3.5 需求5：爆文情况

| 报告字段 | 数据库字段 | 类型 | 说明 |
|----------|-----------|------|------|
| 爆文阈值 | `hot_note_threshold` | numeric | 互动中位数×3 |
| 爆文数量 | `hot_note_count` | integer | 直接取值 |
| 是否达标(>1篇) | `hot_note_pass` | boolean | true/false |
| 爆文列表 | `hot_note_detail` | jsonb | 从 detail 提取 |

### 3.6 需求6：互动趋势

| 报告字段 | 数据库字段 | 类型 | 说明 |
|----------|-----------|------|------|
| 互动趋势状态 | `interaction_trend_status` | text | rising/stable/declining |
| 每日数据 | `interaction_trend_detail` | jsonb | 从 detail 提取 |
| **30天日均曝光** | `daily_imp_avg` | numeric | 直接取值 ✅ |
| **30天日均阅读** | `daily_read_avg` | numeric | 直接取值 ✅ |
| **30天日均互动** | `daily_engage_avg` | numeric | 直接取值 ✅ |

---

## 四、数据来源说明

### 4.1 数据获取流程

```
原始 API 数据 → 原始数据表 (gg_pgy_kol_*) → 分析脚本 → 分析结果表 (gg_pgy_kol_analysis_result)
```

### 4.2 数据来源对应

| 需求 | 原始数据表 | 分析结果字段 |
|------|-----------|-------------|
| 需求1: 粉丝趋势 | `gg_pgy_kol_fans_trend` + `gg_pgy_kol_fans_summary` | `fans_*` |
| 需求2&7: 发帖频率 | `gg_pgy_kol_notes` + `kol_data_summary_v1` | `post_*`, `active_days_7d` |
| 需求3: 数据表现 | `gg_pgy_kol_note_rate` + XHS 原生 API | `read_*`, `like_*`, `collect_*`, `comment_*`, `interaction_*`, `*_beyond_rate` |
| 需求4: 粉丝比例 | `gg_pgy_kol_notes` + `gg_pgy_kol_base_info` | `read_fans_ratio_*`, `comment_gt_20_*`, `comment_max`, `note_count_30d` |
| 需求5: 爆文 | `gg_pgy_kol_notes` + `gg_pgy_kol_note_rate` | `hot_note_*` |
| 需求6: 互动趋势 | `gg_pgy_kol_core_data` | `interaction_trend_*`, `daily_*_avg` |

---

## 五、生成报告的 SQL 示例

### 5.1 获取单个 KOL 的完整分析数据

```sql
SELECT 
    kol_id,
    kol_name,
    
    -- 需求1: 粉丝趋势
    fans_count_current,
    fans_count_30d_ago,
    fans_growth_30d,
    fans_growth_rate_30d,
    fans_trend_status,
    fans_trend_detail->>'positive_days' as positive_days,
    fans_trend_detail->>'negative_days' as negative_days,
    fans_trend_detail->>'avg_daily_change' as avg_daily_change,
    fans_trend_detail->>'beyond_rate' as beyond_rate,
    
    -- 需求2&7: 发帖频率
    post_count_30d,
    post_avg_per_week,
    post_frequency_pass,
    active_days_7d,
    
    -- 需求3: 数据表现
    read_median,
    read_avg,
    like_median,
    like_avg,
    comment_median,
    comment_avg,
    interaction_median,
    interaction_avg,
    read_beyond_rate,
    interaction_beyond_rate,
    
    -- 需求4: 粉丝比例
    read_fans_ratio_avg,
    read_fans_ratio_pass,
    read_fans_ratio_pass_count,
    note_count_30d,
    comment_gt_20_count,
    comment_gt_20_pass,
    comment_max,
    
    -- 需求5: 爆文
    hot_note_count,
    hot_note_pass,
    hot_note_threshold,
    
    -- 需求6: 互动趋势
    interaction_trend_status,
    daily_imp_avg,
    daily_read_avg,
    daily_engage_avg,
    
    -- 综合
    recommendation,
    analysis_notes,
    analysis_date
    
FROM gg_pgy_kol_analysis_result
WHERE kol_id = '556c4eb8e58d13385c4bc6b5'
AND project_name = '枕头分析';
```

### 5.2 获取增长率排名

```sql
SELECT 
    kol_id,
    kol_name,
    fans_growth_rate_30d,
    fans_trend_status,
    RANK() OVER (ORDER BY fans_growth_rate_30d DESC NULLS LAST) as growth_rank
FROM gg_pgy_kol_analysis_result
WHERE project_name = '枕头分析';
```

---

## 六、当前数据状态

### 6.1 需求1 已完成 ✅

| 字段 | 状态 | 说明 |
|------|------|------|
| `fans_count_current` | ✅ 已填充 | 240条数据 |
| `fans_count_30d_ago` | ✅ 已填充 | 240条数据 |
| `fans_growth_30d` | ✅ 已填充 | 240条数据 |
| `fans_growth_rate_30d` | ✅ 已填充 | 240条数据 |
| `fans_trend_status` | ✅ 已填充 | 240条数据 |
| `fans_trend_detail` | ✅ 已填充 | 包含完整过程数据 |

### 6.2 待处理需求

| 需求 | 状态 | 相关字段 |
|------|------|----------|
| 需求2&7: 发帖频率 | ⏳ 待处理 | `post_*`, `active_days_7d` |
| 需求3: 数据表现 | ⏳ 待处理 | `read_*`, `like_*`, `comment_*`, `*_beyond_rate` |
| 需求4: 粉丝比例 | ⏳ 待处理 | `read_fans_ratio_*`, `comment_gt_20_*`, `comment_max`, `note_count_30d` |
| 需求5: 爆文 | ⏳ 待处理 | `hot_note_*` |
| 需求6: 互动趋势 | ⏳ 待处理 | `interaction_trend_*`, `daily_*_avg` |

---

## 七、新增字段清单（2025-12-09）

| 字段名 | 类型 | 说明 | 对应需求 |
|--------|------|------|----------|
| `active_days_7d` | INTEGER | 近7天活跃天数 | 需求2 |
| `read_beyond_rate` | NUMERIC(10,2) | 阅读中位数超越同行比例 | 需求3 |
| `interaction_beyond_rate` | NUMERIC(10,2) | 互动中位数超越同行比例 | 需求3 |
| `comment_max` | INTEGER | 单篇评论最高数 | 需求4 |
| `note_count_30d` | INTEGER | 30天内笔记总数 | 需求4 |
| `daily_imp_avg` | NUMERIC(10,2) | 30天日均曝光 | 需求6 |
| `daily_read_avg` | NUMERIC(10,2) | 30天日均阅读 | 需求6 |
| `daily_engage_avg` | NUMERIC(10,2) | 30天日均互动 | 需求6 |

---

*文档更新时间: 2025-12-09*
