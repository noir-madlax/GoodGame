# 商品标签生成方案 v2.0

> **文档目的**：作为商品标签生成优化方案的总指导文档，指导后续的具体实现
> 
> **适用场景**：为 ZARA 等服装电商客户提供商品标签生成服务
> 
> **输入数据**：商品名称 + 商品图片（客户提供的高质量数据）
> 
> **输出数据**：CAPUS 五维度标签（品类、属性、性能、场景、风格）

---

## 目录

1. [方案概述](#一方案概述)
2. [标签词典生成方案](#二标签词典生成方案)
3. [多模态商品分析流程](#三多模态商品分析流程)
4. [质量校验机制（SQL）](#四质量校验机制)
5. [边界案例处理](#五边界案例处理)
6. [数据库设计](#六数据库设计)
7. [实施步骤](#七实施步骤)
8. [附录](#八附录)

---

## 一、方案概述

### 1.1 核心改进点

| 对比维度 | v1.0 方案 | v2.0 方案 |
|---------|----------|----------|
| 输入数据 | 仅商品标题 | 商品标题 + 商品图片 |
| 标签生成 | LLM 自由创造 | **标签词典约束** |
| 风格判断 | 纯猜测（"百搭"占70%） | **基于图片视觉特征** |
| 质量控制 | 无 | 基本校验 + LLM 校对 |

### 1.2 简化原则

本方案为 Demo 版本，遵循以下原则：
- ✅ 保留核心价值功能（标签词典 + 多模态分析）
- ✅ 保留基本质量校验
- ❌ 省略复杂预处理
- ❌ 省略互斥/蕴含规则
- ❌ 省略标签归一化
- ❌ 省略人工审核流程

### 1.3 整体流程

```
┌──────────────────────────────────────────────────────────────────────┐
│                      商品标签生成流程 v2.0 (简化版)                    │
├──────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  Phase 0          Phase 1           Phase 2           Phase 3       │
│ ┌──────────┐    ┌──────────────┐  ┌──────────────┐  ┌────────────┐  │
│ │ 数据准备  │───▶│ 词典生成      │─▶│ 多模态分析   │─▶│ 向量化     │  │
│ │          │    │ (全量一次性)  │  │ (图片+文本)  │  │            │  │
│ └──────────┘    └──────────────┘  └──────────────┘  └────────────┘  │
│      │                │                 │                 │         │
│      ▼                ▼                 ▼                 ▼         │
│  gg_zara_         gg_tag_          gg_zara_           搜索可用     │
│  products        dictionary       product_apu                       │
│                                                                      │
│  ────────────────────────────────────────────────────────────────   │
│  每个阶段完成后，通过 SQL 查询进行基本校验                            │
└──────────────────────────────────────────────────────────────────────┘
```

---

## 二、标签词典生成方案

### 2.1 词典生成策略

**核心思路**：将全量商品名称一次性提交给 LLM，让 LLM 从全貌中提炼出共性词典

**为什么要全量一次性处理**：
- LLM 能看到所有商品的全貌，理解整体分布
- 自动识别高频词汇和共性特征
- 避免逐个处理后汇总导致的词汇碎片化
- 一次调用，效率高、成本低

### 2.2 词典生成流程

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  全量商品名称    │────▶│   LLM 一次性    │────▶│   标准化词典    │
│  (拼接成列表)    │     │   提炼词典      │     │   (JSON格式)    │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

**输入**：全量商品名称列表（一次性提交）

**输出**：按 CAPUS 五维度组织的标准化词典

### 2.3 词典生成 Prompt

```
你是一个服装电商的商品分析专家。请分析以下全量商品名称列表，从中提炼出标准化的标签词典。

## 全量商品名称列表
{所有商品名称，每行一个，共 N 个商品}

## 任务
从以上全量商品中，提炼出各维度的标准化标签词典。要求：
1. 识别高频、有代表性的词汇
2. 每个词汇只能归属一个维度（不能重复出现在多个维度）
3. 去除品牌名(ZARA)、年份(2024/2025)、编码(数字)等无关词汇
4. 合并同义词，保留最通用的表达（如 oversize 和 宽松 合并为"宽松"）
5. 去除过于泛化的词（如"好看"、"时尚"、"百搭"这类几乎适用于所有商品的词）

## 维度定义

1. **category（品类）**：商品的基本分类，如连衣裙、T恤、针织衫

2. **attribute（属性）**：可从商品名称/图片直接识别的物理特征
   - 版型：修身、宽松、直筒、A字等
   - 领型：圆领、V领、立领、方领等
   - 袖型：短袖、长袖、无袖等
   - 材质：棉、雪纺、针织、牛仔等
   - 工艺/细节：印花、刺绣、褶皱、拼接等

3. **performance（性能）**：商品的功能表现（需要从属性推理）
   - 如：显瘦、透气、保暖、舒适、修饰身材等
   - 注意：这些词通常不直接出现在商品名称中，但是重要的搜索词

4. **use（场景）**：商品适用的场合
   - 如：通勤、约会、度假、日常、运动等

5. **style（风格）**：商品的风格调性（需要结合图片判断）
   - 如：法式、韩系、简约、优雅、街头、复古等
   - 注意：不要使用"时尚"、"百搭"这类泛化词

## 输出格式（严格 JSON）
{
  "category": ["品类1", "品类2", ...],
  "attribute": {
    "版型": ["词1", "词2", ...],
    "领型": ["词1", "词2", ...],
    "袖型": ["词1", "词2", ...],
    "材质": ["词1", "词2", ...],
    "工艺": ["词1", "词2", ...]
  },
  "performance": ["词1", "词2", ...],
  "use": ["词1", "词2", ...],
  "style": ["词1", "词2", ...]
}

## 重要提示
- 词典应该覆盖以上商品列表中出现的主要特征
- 每个维度的词汇数量建议：category 10-20个，attribute 各子维度 5-15个，performance 15-25个，use 10-20个，style 15-25个
- 风格词典中禁止出现"时尚"、"百搭"、"好看"这类泛化词
```

### 2.4 词典结构示例

```json
{
  "category": [
    "连衣裙", "T恤", "衬衫", "针织衫", "毛衣", "卫衣", 
    "外套", "夹克", "大衣", "羽绒服", "西装", "马甲",
    "牛仔裤", "休闲裤", "半身裙", "短裤"
  ],
  "attribute": {
    "版型": ["修身", "宽松", "直筒", "A字", "H型", "收腰"],
    "领型": ["圆领", "V领", "立领", "翻领", "方领", "一字领", "高领"],
    "袖型": ["短袖", "长袖", "无袖", "七分袖", "泡泡袖"],
    "材质": ["棉", "雪纺", "针织", "牛仔", "羊毛", "真丝", "皮革", "麻"],
    "工艺": ["印花", "刺绣", "蕾丝", "褶皱", "拼接", "做旧", "镂空"]
  },
  "performance": [
    "显瘦", "显腿长", "遮肉", "透气", "保暖", "凉爽",
    "舒适", "柔软", "弹性好", "不易皱", "修饰身材"
  ],
  "use": [
    "日常", "通勤", "约会", "聚会", "度假", "海边",
    "运动", "居家", "正式场合", "面试"
  ],
  "style": [
    "简约", "优雅", "知性", "温柔", "休闲", "运动风",
    "街头", "复古", "法式", "韩系", "日系", "甜美", "中性"
  ]
}
```

### 2.5 词典生成后检查（SQL）

词典生成后，通过简单的 SQL 检查基本质量：

```sql
-- 检查词典各维度的词汇数量
SELECT dimension, COUNT(*) as tag_count 
FROM gg_tag_dictionary 
WHERE is_active = true 
GROUP BY dimension;

-- 预期：category >= 10, attribute >= 30 (各子维度合计), 
--       performance >= 10, use >= 10, style >= 10
```

---

## 三、多模态商品分析流程

### 3.1 输入数据规范

| 字段 | 必填 | 说明 |
|-----|------|------|
| item_id | 是 | 商品唯一标识 |
| item_name | 是 | 商品名称 |
| image_urls | 是 | 商品图片URL列表（至少1张） |
| price | 否 | 商品价格 |
| description | 否 | 商品描述（如有可提升准确度） |

### 3.2 分析流程

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   数据输入    │────▶│  Prompt构建  │────▶│  LLM调用     │
└──────────────┘     └──────────────┘     └──────────────┘
                            │                     │
                            │                     ▼
                     ┌──────────────┐     ┌──────────────┐
                     │  标签词典    │     │  结果解析    │
                     │  (从DB加载)  │     │  + 校验      │
                     └──────────────┘     └──────────────┘
                                                 │
                                                 ▼
                                          ┌──────────────┐
                                          │  结果存储    │
                                          └──────────────┘
```

### 3.3 多模态分析 Prompt

```
你是一个专业的服装电商商品分析师。请根据商品图片和名称，生成标准化的商品标签。

## 商品信息
- 名称: {清洗后的商品名称}
- 价格: {价格，如有}

## 重要规则
1. **必须从词典选择**：所有标签必须来自下方词典，不允许创造新标签
2. **图片优先**：风格判断必须基于图片视觉特征
3. **提供置信度**：每个维度给出 0-1 的置信度
4. **说明依据**：风格维度必须说明从图片哪里看出来的

## 标签词典

### 品类（必选1个）
{从数据库加载的品类列表}

### 属性（选3-8个）
版型: {词典}
领型: {词典}
袖型: {词典}
材质: {词典}
工艺: {词典}

### 性能（选2-5个）
{词典}

### 场景（选2-5个）
{词典}

### 风格（选1-3个）
{词典}

## 风格判断指南
- **简约/基础**：纯色、无装饰、经典剪裁
- **优雅/知性**：柔和色彩、精致细节、女性化线条
- **法式**：方领/V领、泡泡袖、碎花、飘逸感
- **休闲/运动**：宽松版型、舒适面料、活力元素
- **街头/潮流**：oversize、logo、撞色、解构设计
- **复古**：特定年代特征（波点、格纹、喇叭袖等）

## 输出格式（严格JSON）
{
  "core_description": "清洗后的核心商品描述",
  "category": "品类（单选）",
  "attribute": {
    "keywords": ["标签1", "标签2", ...],
    "confidence": 0.95
  },
  "performance": {
    "keywords": ["标签1", "标签2", ...],
    "confidence": 0.85,
    "reasoning": "推理过程"
  },
  "use": {
    "keywords": ["标签1", "标签2", ...],
    "confidence": 0.80,
    "reasoning": "推理过程"
  },
  "style": {
    "keywords": ["标签1", "标签2", ...],
    "confidence": 0.88,
    "evidence": "从图片中观察到：xxx，因此判断为xxx风格"
  },
  "enhanced_text": "融合五维度的搜索增强文本"
}
```

### 3.4 LLM 调用参数

| 参数 | 推荐值 | 说明 |
|-----|-------|------|
| model | gpt-4o | 视觉能力最强，也可用 claude-3.5-sonnet |
| temperature | 0.3 | 低温度保证输出稳定 |
| max_tokens | 1500 | 足够输出完整 JSON |
| response_format | json_object | 强制 JSON 输出 |
| image_detail | high | 高清模式，提取更多视觉细节 |

---

## 四、质量校验机制

### 4.1 设计原则

- ✅ 只检查**绝对有问题**的情况
- ✅ 通过 **SQL 查询**完成，不调用 LLM
- ✅ 简单高效，快速定位问题

### 4.2 校验 SQL 清单

#### 校验 1：分析失败的商品

```sql
-- 查找分析状态为失败的商品
SELECT p.item_id, p.item_name, a.analysis_status
FROM gg_zara_products p
LEFT JOIN gg_zara_product_apu a ON p.id = a.product_id
WHERE a.analysis_status = 'failed' OR a.product_id IS NULL;

-- 预期：数量为 0 或极少
```

#### 校验 2：品类为空

```sql
-- 查找品类为空的商品（绝对错误）
SELECT p.item_id, p.item_name, a.category
FROM gg_zara_products p
JOIN gg_zara_product_apu a ON p.id = a.product_id
WHERE a.category IS NULL OR a.category = '';

-- 预期：数量为 0
```

#### 校验 3：风格标签全为空

```sql
-- 查找风格完全为空的商品
SELECT p.item_id, p.item_name
FROM gg_zara_products p
JOIN gg_zara_product_apu a ON p.id = a.product_id
WHERE a.style_keywords IS NULL OR array_length(a.style_keywords, 1) IS NULL;

-- 预期：数量极少（< 5%）
```

#### 校验 4：风格分布检查（核心改进指标）

```sql
-- 统计各风格标签的使用次数
SELECT unnest(style_keywords) as style, COUNT(*) as count
FROM gg_zara_product_apu
GROUP BY style
ORDER BY count DESC;

-- 关注点：
-- 1. "百搭" 占比应该 < 30%（v1 是 70%）
-- 2. 应该有多样化的风格分布
```

#### 校验 5：品类分布检查

```sql
-- 统计各品类的商品数量
SELECT category, COUNT(*) as count
FROM gg_zara_product_apu
GROUP BY category
ORDER BY count DESC;

-- 关注点：分布应该合理，与实际商品构成一致
```

#### 校验 6：非词典标签检查

```sql
-- 查找使用了非词典标签的商品（品类维度）
SELECT a.product_id, a.category
FROM gg_zara_product_apu a
WHERE a.category NOT IN (
  SELECT tag_name FROM gg_tag_dictionary 
  WHERE dimension = 'category' AND is_active = true
);

-- 预期：数量为 0（所有品类都应在词典中）
```

### 4.3 校验执行时机

| 时机 | 执行校验 |
|-----|---------|
| 全量分析完成后 | 执行所有 6 个校验 SQL |
| 发现问题时 | 人工处理或调整词典/Prompt 后重跑 |

### 4.4 问题处理策略

| 问题类型 | 处理方式 |
|---------|---------|
| 分析失败 | 重试该商品，或人工检查原因 |
| 品类为空 | 重新分析该商品 |
| 风格全空 | 检查图片是否可访问，或 Prompt 是否有问题 |
| 风格过于集中 | 调整 Prompt 中的风格判断指南 |
| 非词典标签 | 补充词典或重新分析 |

---

## 五、边界案例处理

### 5.1 常见边界案例及处理

通过 SQL 校验发现的问题，按以下方式处理：

| 边界案例 | 识别方式 | 处理方式 |
|---------|---------|---------|
| 图片无法访问 | 分析失败 | 检查 URL，重新获取图片 |
| 商品名称过短 | 品类/属性为空 | 人工补充或重新分析 |
| 多品类商品（如套装） | 品类判断不准 | 人工指定主品类 |
| 中性风格商品 | 风格为空 | 可接受，或标记为"简约" |

### 5.2 后续优化方向

如果 Demo 效果好，可以考虑增加：

1. **互斥规则校验**（SQL 实现）
```sql
-- 检查同时有"修身"和"宽松"的商品
SELECT product_id, attribute_keywords
FROM gg_zara_product_apu
WHERE 'x修身' = ANY(attribute_keywords) AND '宽松' = ANY(attribute_keywords);
```

2. **蕴含规则校验**（SQL 实现）
```sql
-- 检查羽绒服是否都有"保暖"标签
SELECT product_id, category, performance_keywords
FROM gg_zara_product_apu
WHERE category = '羽绒服' AND NOT ('保暖' = ANY(performance_keywords));
```

这些可以在 Demo 验证后按需添加。

---

## 六、数据库设计

### 6.1 新增表结构

#### 表1: gg_tag_dictionary（标签词典）

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | serial | 主键 |
| dimension | varchar(50) | 维度：category/attribute/performance/use/style |
| sub_dimension | varchar(50) | 子维度（仅attribute有）：版型/领型/袖型/材质/工艺 |
| tag_name | varchar(100) | 标签名称 |
| tag_description | text | 标签定义说明 |
| examples | text[] | 使用示例 |
| is_active | boolean | 是否启用，默认 true |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

**索引**：
- `idx_tag_dictionary_dimension` on (dimension)
- `idx_tag_dictionary_active` on (is_active)
- `unique_tag_dimension` on (dimension, sub_dimension, tag_name)

#### 表2: gg_zara_products（ZARA商品表）

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | serial | 主键 |
| item_id | varchar(100) | 商品ID（客户提供） |
| item_name | varchar(500) | 原始商品名称 |
| image_urls | text[] | 图片URL列表 |
| price | decimal | 价格 |
| source | varchar(50) | 数据来源：zara_batch_1 等 |
| created_at | timestamp | 创建时间 |

**索引**：
- `unique_zara_item_id` on (item_id)
- `idx_zara_source` on (source)

#### 表3: gg_zara_product_apu（ZARA商品APU分析结果）

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | serial | 主键 |
| product_id | integer | 关联 gg_zara_products.id |
| core_description | varchar(500) | 清洗后的核心描述 |
| category | varchar(100) | 品类 |
| attribute_keywords | text[] | 属性标签数组 |
| attribute_confidence | decimal | 属性置信度 |
| performance_keywords | text[] | 性能标签数组 |
| performance_confidence | decimal | 性能置信度 |
| use_keywords | text[] | 场景标签数组 |
| use_confidence | decimal | 场景置信度 |
| style_keywords | text[] | 风格标签数组 |
| style_confidence | decimal | 风格置信度 |
| style_evidence | text | 风格判断依据 |
| enhanced_text | text | 增强搜索文本 |
| analysis_status | varchar(20) | 状态：pending/success/failed/needs_review |
| validation_warnings | jsonb | 校验警告 |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

**索引**：
- `unique_zara_apu_product` on (product_id)
- `idx_zara_apu_status` on (analysis_status)
- `idx_zara_apu_category` on (category)

### 6.2 数据隔离说明

- 新数据使用 `gg_zara_*` 前缀的表，与原有 `gg_taobao_*` 表完全隔离
- 前端搜索时通过表名/source字段区分数据源
- 词典表 `gg_tag_dictionary` 可共用，也可按 source 区分

---

## 七、实施步骤

### Phase 0: 准备工作（0.5天）

#### Step 0.1: 数据库准备
- [ ] 创建新表结构（gg_tag_dictionary, gg_zara_products, gg_zara_product_apu）
- [ ] 添加必要索引

#### Step 0.2: 数据导入
- [ ] 接收客户提供的商品数据（名称+图片）
- [ ] 导入 gg_zara_products 表

**SQL 校验**：
```sql
-- 检查数据导入
SELECT COUNT(*) FROM gg_zara_products;
-- 检查是否有空名称
SELECT COUNT(*) FROM gg_zara_products WHERE item_name IS NULL OR item_name = '';
```

---

### Phase 1: 词典生成（0.5天）

#### Step 1.1: 全量词典提炼
- [ ] 拼接全量商品名称
- [ ] 调用 LLM 一次性提炼词典（使用 2.3 的 Prompt）
- [ ] 人工 review 词典内容（重点检查风格维度）
- [ ] 调整后导入 gg_tag_dictionary 表

**SQL 校验**：
```sql
-- 检查各维度词汇数量
SELECT dimension, COUNT(*) as tag_count 
FROM gg_tag_dictionary 
WHERE is_active = true 
GROUP BY dimension;
```

---

### Phase 2: 多模态分析（1天）

#### Step 2.1: 小批量测试
- [ ] 选取 5-10 个商品进行测试
- [ ] 检查输出是否符合预期
- [ ] 调整 Prompt（如需要）

#### Step 2.2: 全量分析
- [ ] 对所有商品执行多模态分析
- [ ] 结果存入 gg_zara_product_apu 表

**SQL 校验**：
```sql
-- 检查分析成功率
SELECT 
  COUNT(*) as total,
  SUM(CASE WHEN analysis_status = 'success' THEN 1 ELSE 0 END) as success,
  SUM(CASE WHEN analysis_status = 'failed' THEN 1 ELSE 0 END) as failed
FROM gg_zara_product_apu;

-- 检查风格分布（核心指标）
SELECT unnest(style_keywords) as style, COUNT(*) as count
FROM gg_zara_product_apu
GROUP BY style
ORDER BY count DESC;

-- 检查品类为空
SELECT COUNT(*) FROM gg_zara_product_apu 
WHERE category IS NULL OR category = '';
```

---

### Phase 3: 向量化与测试（0.5天）

#### Step 3.1: 向量化
- [ ] 对 enhanced_text 进行向量化
- [ ] 存入向量表

#### Step 3.2: 搜索测试
- [ ] 测试文字搜索
- [ ] 测试风格搜索（如"法式连衣裙"）
- [ ] 验证结果相关性

**SQL 校验**：
```sql
-- 检查向量化完成
SELECT COUNT(*) FROM gg_zara_product_embeddings;
```

---

### 总时间：约 2.5 天

---

## 八、附录

### 8.1 推荐 LLM 模型

| 模型 | 适用场景 | 成本 | 说明 |
|-----|---------|------|------|
| gpt-4o | 多模态分析 | ~$0.02/商品 | 视觉能力最强，首选 |
| claude-3.5-sonnet | 多模态分析 | ~$0.015/商品 | 备选 |
| gemini-2.0-flash | 词典生成 | ~$0.01/次 | 纯文本任务 |

### 8.2 成本估算（100 个商品）

| 阶段 | 调用次数 | 估算成本 |
|-----|---------|---------|
| 词典生成 | 1次 | ~$0.05 |
| 多模态分析 | 100次 | ~$2.00 |
| **总计** | | **~$2.05** |

### 8.3 关键成功指标

| 指标 | 目标值 | 说明 |
|-----|-------|------|
| 分析成功率 | >= 95% | 通过 SQL 检查 |
| 风格多样性 | "百搭"占比 < 30% | v1 是 70%，这是核心改进 |
| 品类准确率 | >= 98% | 品类判断应该很准 |

### 8.4 后续优化方向

1. **前端词典管理**：支持前端查看和维护词典
2. **互斥规则**：SQL 校验逻辑冲突的标签
3. **多图分析**：利用多张图片提取更多信息
4. **专用模型**：数据积累后考虑微调

---

## 变更记录

| 版本 | 日期 | 变更内容 |
|-----|------|---------|
| v2.0 | 2024-12-12 | 初始版本 |
| v2.1 | 2024-12-12 | 简化方案：词典全量生成、SQL校验 |


