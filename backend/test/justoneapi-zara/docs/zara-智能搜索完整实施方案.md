# ZARA 智能搜索完整实施方案

## 文档信息

| 项目     | 说明                                                     |
| -------- | -------------------------------------------------------- |
| 版本     | v1.0                                                     |
| 创建日期 | 2025-12-12                                               |
| 适用范围 | ZARA 商品智能搜索系统                                    |
| 目标     | 为商品生成高质量标签 + 实现精准语义搜索                  |

---

## 一、项目概述

### 1.1 项目总体目标

为 ZARA 等服装电商客户构建一个智能搜索系统，实现：

1. **语义理解搜索**：用户搜"宽松休闲的女装牛仔裤"，系统能理解"女装"、"牛仔裤"是硬过滤条件，"宽松休闲"是偏好
2. **精准过滤**：搜索"女装"绝对不会出现童装/男装
3. **多维度语义匹配**：基于 APUS（属性、性能、场景、风格）四个维度进行向量语义匹配，而非简单关键词匹配

### 1.2 当前问题

| 问题            | 具体表现                           | 影响程度 |
| --------------- | ---------------------------------- | -------- |
| APUS 匹配不精准 | 使用关键词文本匹配，无法理解同义词 | 高       |
| 无性别过滤      | 搜索"女装裙子"可能返回童装/男装    | 严重     |
| 品类过滤不严格  | 品类只作为加权因子，非硬过滤       | 严重     |
| 性别数据缺失    | 商品表中无性别字段                 | 高       |
| 风格标签质量差  | LLM 自由创造，"百搭"占 70%         | 高       |

### 1.3 项目分阶段概述

本项目分为两大阶段：

| 阶段 | 名称 | 定位 | 职责 |
|------|------|------|------|
| 阶段 A | 数据基础建设 | **上游 - 数据处理** | 为商品生成高质量的标签（品类、属性、性能、场景、风格） |
| 阶段 B | 搜索系统改造 | **下游 - 搜索服务** | 利用这些标签实现精准语义搜索 |

**数据流**：商品原始数据 → 标签生成 → 向量化 → 搜索系统可用

### 1.4 整体流程图

```
阶段 A（数据处理）                        阶段 B（搜索服务）
┌─────────────────────────┐            ┌─────────────────────────┐
│ A1: 数据准备             │            │ B1: 数据库结构升级       │
│       ↓                 │            │       ↓                 │
│ A2: 词典生成             │            │ B2: 搜索 API 改造        │
│       ↓                 │            │       ↓                 │
│ A3: 多模态商品分析       │ ────────── │ B3: 前端更新             │
│       ↓                 │            └─────────────────────────┘
│ A4: 向量化               │
└─────────────────────────┘
```

**依赖关系**：
- A1-A4 是串行的
- B1 可以和 A 阶段并行
- B2-B3 需要 A4 完成后才能测试

---

## 二、阶段 A：数据基础建设（上游）

**阶段目标**：为商品生成高质量、标准化的 CAPUS 五维度标签

**输入数据**：商品名称 + 商品图片（客户提供的高质量数据）

**输出数据**：CAPUS 五维度标签（品类、属性、性能、场景、风格）+ 向量

### 2.1 核心改进点（相比 v1.0）

| 对比维度 | v1.0 方案 | v2.0 方案 |
|---------|----------|----------|
| 输入数据 | 仅商品标题 | 商品标题 + 商品图片 |
| 标签生成 | LLM 自由创造 | **标签词典约束** |
| 风格判断 | 纯猜测（"百搭"占70%） | **基于图片视觉特征** |
| 质量控制 | 无 | 基本校验 + SQL 检查 |

### 2.2 简化原则

本方案为 Demo 版本，遵循以下原则：
- ✅ 保留核心价值功能（标签词典 + 多模态分析）
- ✅ 保留基本质量校验
- ❌ 省略复杂预处理
- ❌ 省略互斥/蕴含规则
- ❌ 省略标签归一化
- ❌ 省略人工审核流程

---

### A1: 数据准备

**目标**：准备好商品原始数据和数据库表结构

**意义**：搭建数据存储的地基

#### A1.1 数据库表创建

##### 表1: gg_tag_dictionary（标签词典）

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | serial | 主键 |
| dimension | varchar(50) | 维度：category/attribute/performance/use/style |
| sub_dimension | varchar(50) | 子维度（仅attribute有）：版型/领型/袖型/材质/工艺 |
| tag_name | varchar(100) | 标签名称 |
| tag_description | text | 标签定义说明 |
| examples | text[] | 使用示例 |
| is_active | boolean | 是否启用，默认 true |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

**索引**：
- `idx_tag_dictionary_dimension` on (dimension)
- `idx_tag_dictionary_active` on (is_active)
- `unique_tag_dimension` on (dimension, sub_dimension, tag_name)

##### 表2: gg_zara_products（ZARA商品表）

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | serial | 主键 |
| item_id | varchar(100) | 商品ID（客户提供） |
| item_name | varchar(500) | 原始商品名称 |
| image_urls | text[] | 图片URL列表 |
| price | decimal | 价格 |
| source | varchar(50) | 数据来源：zara_batch_1 等 |
| created_at | timestamp | 创建时间 |

**索引**：
- `unique_zara_item_id` on (item_id)
- `idx_zara_source` on (source)

##### 表3: gg_zara_product_apu（ZARA商品APU分析结果）

| 字段 | 类型 | 说明 |
|-----|------|------|
| id | serial | 主键 |
| product_id | integer | 关联 gg_zara_products.id |
| core_description | varchar(500) | 清洗后的核心描述 |
| category | varchar(100) | 品类 |
| attribute_keywords | text[] | 属性标签数组 |
| attribute_confidence | decimal | 属性置信度 |
| performance_keywords | text[] | 性能标签数组 |
| performance_confidence | decimal | 性能置信度 |
| use_keywords | text[] | 场景标签数组 |
| use_confidence | decimal | 场景置信度 |
| style_keywords | text[] | 风格标签数组 |
| style_confidence | decimal | 风格置信度 |
| style_evidence | text | 风格判断依据 |
| enhanced_text | text | 增强搜索文本 |
| analysis_status | varchar(20) | 状态：pending/success/failed/needs_review |
| validation_warnings | jsonb | 校验警告 |
| created_at | timestamp | 创建时间 |
| updated_at | timestamp | 更新时间 |

**索引**：
- `unique_zara_apu_product` on (product_id)
- `idx_zara_apu_status` on (analysis_status)
- `idx_zara_apu_category` on (category)

#### A1.2 数据导入

- 接收客户提供的商品数据（名称+图片）
- 导入 gg_zara_products 表

#### A1.3 输入数据规范

| 字段 | 必填 | 说明 |
|-----|------|------|
| item_id | 是 | 商品唯一标识 |
| item_name | 是 | 商品名称 |
| image_urls | 是 | 商品图片URL列表（至少1张） |
| price | 否 | 商品价格 |
| description | 否 | 商品描述（如有可提升准确度） |

#### A1.4 SQL 校验

```sql
-- 检查数据导入
SELECT COUNT(*) FROM gg_zara_products;

-- 检查是否有空名称
SELECT COUNT(*) FROM gg_zara_products WHERE item_name IS NULL OR item_name = '';
```

#### A1.5 实施清单

| 步骤 | 内容 | 产出 |
| ---- | ---- | ---- |
| A1.1 | 创建新表结构 | DDL 执行完成 |
| A1.2 | 添加必要索引 | 索引创建完成 |
| A1.3 | 接收客户商品数据 | 原始数据文件 |
| A1.4 | 导入 gg_zara_products 表 | 数据入库完成 |
| A1.5 | SQL 校验数据质量 | 校验报告 |

**预计时间**：0.5 天

---

### A2: 词典生成

**目标**：从全量商品中提炼出标准化的标签词典

**意义**：
- v1.0 的问题是 LLM 自由创造标签，导致"百搭"占 70%
- 词典约束后，LLM 必须从词典中选择，保证标签质量和一致性

#### A2.1 词典生成策略

**核心思路**：将全量商品名称一次性提交给 LLM，让 LLM 从全貌中提炼出共性词典

**为什么要全量一次性处理**：
- LLM 能看到所有商品的全貌，理解整体分布
- 自动识别高频词汇和共性特征
- 避免逐个处理后汇总导致的词汇碎片化
- 一次调用，效率高、成本低

#### A2.2 词典生成流程

```
┌─────────────────┐     ┌─────────────────┐     ┌─────────────────┐
│  全量商品名称    │────▶│   LLM 一次性    │────▶│   标准化词典    │
│  (拼接成列表)    │     │   提炼词典      │     │   (JSON格式)    │
└─────────────────┘     └─────────────────┘     └─────────────────┘
```

**输入**：全量商品名称列表（一次性提交）

**输出**：按 CAPUS 五维度组织的标准化词典

#### A2.3 维度定义

1. **category（品类）**：商品的基本分类，如连衣裙、T恤、针织衫

2. **attribute（属性）**：可从商品名称/图片直接识别的物理特征
   - 版型：修身、宽松、直筒、A字等
   - 领型：圆领、V领、立领、方领等
   - 袖型：短袖、长袖、无袖等
   - 材质：棉、雪纺、针织、牛仔等
   - 工艺/细节：印花、刺绣、褶皱、拼接等

3. **performance（性能）**：商品的功能表现（需要从属性推理）
   - 如：显瘦、透气、保暖、舒适、修饰身材等
   - 注意：这些词通常不直接出现在商品名称中，但是重要的搜索词

4. **use（场景）**：商品适用的场合
   - 如：通勤、约会、度假、日常、运动等

5. **style（风格）**：商品的风格调性（需要结合图片判断）
   - 如：法式、韩系、简约、优雅、街头、复古等
   - 注意：不要使用"时尚"、"百搭"这类泛化词

#### A2.4 词典生成 Prompt

```
你是一个服装电商的商品分析专家。请分析以下全量商品名称列表，从中提炼出标准化的标签词典。

## 全量商品名称列表
{所有商品名称，每行一个，共 N 个商品}

## 任务
从以上全量商品中，提炼出各维度的标准化标签词典。要求：
1. 识别高频、有代表性的词汇
2. 每个词汇只能归属一个维度（不能重复出现在多个维度）
3. 去除品牌名(ZARA)、年份(2024/2025)、编码(数字)等无关词汇
4. 合并同义词，保留最通用的表达（如 oversize 和 宽松 合并为"宽松"）
5. 去除过于泛化的词（如"好看"、"时尚"、"百搭"这类几乎适用于所有商品的词）

## 维度定义

1. **category（品类）**：商品的基本分类，如连衣裙、T恤、针织衫

2. **attribute（属性）**：可从商品名称/图片直接识别的物理特征
   - 版型：修身、宽松、直筒、A字等
   - 领型：圆领、V领、立领、方领等
   - 袖型：短袖、长袖、无袖等
   - 材质：棉、雪纺、针织、牛仔等
   - 工艺/细节：印花、刺绣、褶皱、拼接等

3. **performance（性能）**：商品的功能表现（需要从属性推理）
   - 如：显瘦、透气、保暖、舒适、修饰身材等
   - 注意：这些词通常不直接出现在商品名称中，但是重要的搜索词

4. **use（场景）**：商品适用的场合
   - 如：通勤、约会、度假、日常、运动等

5. **style（风格）**：商品的风格调性（需要结合图片判断）
   - 如：法式、韩系、简约、优雅、街头、复古等
   - 注意：不要使用"时尚"、"百搭"这类泛化词

## 输出格式（严格 JSON）
{
  "category": ["品类1", "品类2", ...],
  "attribute": {
    "版型": ["词1", "词2", ...],
    "领型": ["词1", "词2", ...],
    "袖型": ["词1", "词2", ...],
    "材质": ["词1", "词2", ...],
    "工艺": ["词1", "词2", ...]
  },
  "performance": ["词1", "词2", ...],
  "use": ["词1", "词2", ...],
  "style": ["词1", "词2", ...]
}

## 重要提示
- 词典应该覆盖以上商品列表中出现的主要特征
- 每个维度的词汇数量建议：category 10-20个，attribute 各子维度 5-15个，performance 15-25个，use 10-20个，style 15-25个
- 风格词典中禁止出现"时尚"、"百搭"、"好看"这类泛化词
```

#### A2.5 词典结构示例

```json
{
  "category": [
    "连衣裙", "T恤", "衬衫", "针织衫", "毛衣", "卫衣", 
    "外套", "夹克", "大衣", "羽绒服", "西装", "马甲",
    "牛仔裤", "休闲裤", "半身裙", "短裤"
  ],
  "attribute": {
    "版型": ["修身", "宽松", "直筒", "A字", "H型", "收腰"],
    "领型": ["圆领", "V领", "立领", "翻领", "方领", "一字领", "高领"],
    "袖型": ["短袖", "长袖", "无袖", "七分袖", "泡泡袖"],
    "材质": ["棉", "雪纺", "针织", "牛仔", "羊毛", "真丝", "皮革", "麻"],
    "工艺": ["印花", "刺绣", "蕾丝", "褶皱", "拼接", "做旧", "镂空"]
  },
  "performance": [
    "显瘦", "显腿长", "遮肉", "透气", "保暖", "凉爽",
    "舒适", "柔软", "弹性好", "不易皱", "修饰身材"
  ],
  "use": [
    "日常", "通勤", "约会", "聚会", "度假", "海边",
    "运动", "居家", "正式场合", "面试"
  ],
  "style": [
    "简约", "优雅", "知性", "温柔", "休闲", "运动风",
    "街头", "复古", "法式", "韩系", "日系", "甜美", "中性"
  ]
}
```

#### A2.6 SQL 校验

```sql
-- 检查词典各维度的词汇数量
SELECT dimension, COUNT(*) as tag_count 
FROM gg_tag_dictionary 
WHERE is_active = true 
GROUP BY dimension;

-- 预期：category >= 10, attribute >= 30 (各子维度合计), 
--       performance >= 10, use >= 10, style >= 10
```

#### A2.7 实施清单

| 步骤 | 内容 | 产出 |
| ---- | ---- | ---- |
| A2.1 | 拼接全量商品名称 | 名称列表文本 |
| A2.2 | 调用 LLM 提炼词典 | 词典 JSON |
| A2.3 | 人工 review（重点检查风格维度） | 审核后的词典 |
| A2.4 | 导入 gg_tag_dictionary 表 | 词典入库完成 |
| A2.5 | SQL 校验词汇数量 | 校验报告 |

**预计时间**：0.5 天

---

### A3: 多模态商品分析

**目标**：为每个商品生成五维度标签

**意义**：
- 核心改进是**基于图片判断风格**，而非纯猜测
- 有了词典约束，标签质量大幅提升

#### A3.1 分析流程

```
┌──────────────┐     ┌──────────────┐     ┌──────────────┐
│   数据输入    │────▶│  Prompt构建  │────▶│  LLM调用     │
└──────────────┘     └──────────────┘     └──────────────┘
                            │                     │
                            │                     ▼
                     ┌──────────────┐     ┌──────────────┐
                     │  标签词典    │     │  结果解析    │
                     │  (从DB加载)  │     │  + 校验      │
                     └──────────────┘     └──────────────┘
                                                 │
                                                 ▼
                                          ┌──────────────┐
                                          │  结果存储    │
                                          └──────────────┘
```

#### A3.2 多模态分析 Prompt

```
你是一个专业的服装电商商品分析师。请根据商品图片和名称，生成标准化的商品标签。

## 商品信息
- 名称: {清洗后的商品名称}
- 价格: {价格，如有}

## 重要规则
1. **必须从词典选择**：所有标签必须来自下方词典，不允许创造新标签
2. **图片优先**：风格判断必须基于图片视觉特征
3. **提供置信度**：每个维度给出 0-1 的置信度
4. **说明依据**：风格维度必须说明从图片哪里看出来的

## 标签词典

### 品类（必选1个）
{从数据库加载的品类列表}

### 属性（选3-8个）
版型: {词典}
领型: {词典}
袖型: {词典}
材质: {词典}
工艺: {词典}

### 性能（选2-5个）
{词典}

### 场景（选2-5个）
{词典}

### 风格（选1-3个）
{词典}

## 风格判断指南
- **简约/基础**：纯色、无装饰、经典剪裁
- **优雅/知性**：柔和色彩、精致细节、女性化线条
- **法式**：方领/V领、泡泡袖、碎花、飘逸感
- **休闲/运动**：宽松版型、舒适面料、活力元素
- **街头/潮流**：oversize、logo、撞色、解构设计
- **复古**：特定年代特征（波点、格纹、喇叭袖等）

## 输出格式（严格JSON）
{
  "core_description": "清洗后的核心商品描述",
  "category": "品类（单选）",
  "attribute": {
    "keywords": ["标签1", "标签2", ...],
    "confidence": 0.95
  },
  "performance": {
    "keywords": ["标签1", "标签2", ...],
    "confidence": 0.85,
    "reasoning": "推理过程"
  },
  "use": {
    "keywords": ["标签1", "标签2", ...],
    "confidence": 0.80,
    "reasoning": "推理过程"
  },
  "style": {
    "keywords": ["标签1", "标签2", ...],
    "confidence": 0.88,
    "evidence": "从图片中观察到：xxx，因此判断为xxx风格"
  },
  "enhanced_text": "融合五维度的搜索增强文本"
}
```

#### A3.3 LLM 调用参数

| 参数 | 推荐值 | 说明 |
|-----|-------|------|
| model | gpt-4o | 视觉能力最强，也可用 claude-3.5-sonnet |
| temperature | 0.3 | 低温度保证输出稳定 |
| max_tokens | 1500 | 足够输出完整 JSON |
| response_format | json_object | 强制 JSON 输出 |
| image_detail | high | 高清模式，提取更多视觉细节 |

#### A3.4 SQL 校验

##### 校验 1：分析失败的商品

```sql
-- 查找分析状态为失败的商品
SELECT p.item_id, p.item_name, a.analysis_status
FROM gg_zara_products p
LEFT JOIN gg_zara_product_apu a ON p.id = a.product_id
WHERE a.analysis_status = 'failed' OR a.product_id IS NULL;

-- 预期：数量为 0 或极少
```

##### 校验 2：品类为空

```sql
-- 查找品类为空的商品（绝对错误）
SELECT p.item_id, p.item_name, a.category
FROM gg_zara_products p
JOIN gg_zara_product_apu a ON p.id = a.product_id
WHERE a.category IS NULL OR a.category = '';

-- 预期：数量为 0
```

##### 校验 3：风格标签全为空

```sql
-- 查找风格完全为空的商品
SELECT p.item_id, p.item_name
FROM gg_zara_products p
JOIN gg_zara_product_apu a ON p.id = a.product_id
WHERE a.style_keywords IS NULL OR array_length(a.style_keywords, 1) IS NULL;

-- 预期：数量极少（< 5%）
```

##### 校验 4：风格分布检查（核心改进指标）

```sql
-- 统计各风格标签的使用次数
SELECT unnest(style_keywords) as style, COUNT(*) as count
FROM gg_zara_product_apu
GROUP BY style
ORDER BY count DESC;

-- 关注点：
-- 1. "百搭" 占比应该 < 30%（v1 是 70%）
-- 2. 应该有多样化的风格分布
```

##### 校验 5：品类分布检查

```sql
-- 统计各品类的商品数量
SELECT category, COUNT(*) as count
FROM gg_zara_product_apu
GROUP BY category
ORDER BY count DESC;

-- 关注点：分布应该合理，与实际商品构成一致
```

##### 校验 6：非词典标签检查

```sql
-- 查找使用了非词典标签的商品（品类维度）
SELECT a.product_id, a.category
FROM gg_zara_product_apu a
WHERE a.category NOT IN (
  SELECT tag_name FROM gg_tag_dictionary 
  WHERE dimension = 'category' AND is_active = true
);

-- 预期：数量为 0（所有品类都应在词典中）
```

#### A3.5 边界案例处理

| 边界案例 | 识别方式 | 处理方式 |
|---------|---------|---------|
| 图片无法访问 | 分析失败 | 检查 URL，重新获取图片 |
| 商品名称过短 | 品类/属性为空 | 人工补充或重新分析 |
| 多品类商品（如套装） | 品类判断不准 | 人工指定主品类 |
| 中性风格商品 | 风格为空 | 可接受，或标记为"简约" |

#### A3.6 问题处理策略

| 问题类型 | 处理方式 |
|---------|---------|
| 分析失败 | 重试该商品，或人工检查原因 |
| 品类为空 | 重新分析该商品 |
| 风格全空 | 检查图片是否可访问，或 Prompt 是否有问题 |
| 风格过于集中 | 调整 Prompt 中的风格判断指南 |
| 非词典标签 | 补充词典或重新分析 |

#### A3.7 实施清单

| 步骤 | 内容 | 产出 |
| ---- | ---- | ---- |
| A3.1 | 选取 5-10 个商品进行小批量测试 | 测试结果 |
| A3.2 | 检查输出是否符合预期，调整 Prompt | 优化后的 Prompt |
| A3.3 | 全量商品执行多模态分析 | 分析结果入库 |
| A3.4 | 执行 6 个 SQL 校验 | 校验报告 |
| A3.5 | 处理边界案例和问题 | 修复完成 |

**预计时间**：1 天

---

### A4: 向量化

**目标**：将标签文本转化为向量，供搜索使用

**意义**：向量是语义搜索的基础，必须和搜索时使用同一模型

#### A4.1 向量化流程

```
┌─────────────────────────────────────────────────────────────────────────┐
│                    向量化                                                │
│  ┌───────────────────────────────────────────────────────────────────┐  │
│  │ 使用模型：text-embedding-3-small（必须与搜索模型一致）               │  │
│  │                                                                   │  │
│  │ 向量化内容：                                                        │  │
│  │ 1. text_enhanced → text_enhanced_embedding                        │  │
│  │ 2. attribute_keywords.join(' ') → attribute_embedding             │  │
│  │ 3. performance_keywords.join(' ') → performance_embedding         │  │
│  │ 4. use_keywords.join(' ') → use_embedding                         │  │
│  │ 5. style_keywords.join(' ') → style_embedding                     │  │
│  │                                                                   │  │
│  │ 向量维度：1536                                                     │  │
│  └───────────────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
```

#### A4.2 向量模型一致性要求

| 场景                      | 模型                       | 维度 | 必须一致 |
| ------------------------- | -------------------------- | ---- | -------- |
| 商品 text_enhanced 向量化 | `text-embedding-3-small` | 1536 | ✅       |
| 商品 APUS 四维度向量化    | `text-embedding-3-small` | 1536 | ✅       |
| 搜索时用户意图向量化      | `text-embedding-3-small` | 1536 | ✅       |
| 性别/品类语义判断         | `text-embedding-3-small` | 1536 | ✅       |

#### A4.3 一致性检查点

在实施过程中必须确认：

- [ ] 所有向量化调用使用同一个 embedding API endpoint
- [ ] 所有向量化调用使用同一个模型名称 `text-embedding-3-small`
- [ ] 所有存储的向量维度为 1536
- [ ] 搜索时的向量化与入库时的向量化使用相同配置

#### A4.4 SQL 校验

```sql
-- 检查向量化完成
SELECT COUNT(*) FROM gg_zara_product_embeddings;

-- 检查向量维度（如果数据库支持）
-- 验证所有向量字段不为空
SELECT COUNT(*) FROM gg_zara_product_embeddings 
WHERE text_enhanced_embedding IS NULL 
   OR attribute_embedding IS NULL
   OR performance_embedding IS NULL
   OR use_embedding IS NULL
   OR style_embedding IS NULL;
```

#### A4.5 实施清单

| 步骤 | 内容 | 产出 |
| ---- | ---- | ---- |
| A4.1 | 编写向量化脚本 | 脚本文件 |
| A4.2 | 对 enhanced_text 进行向量化 | 向量入库 |
| A4.3 | 对四维度关键词进行向量化 | 向量入库 |
| A4.4 | 验证向量维度和存储 | 验证报告 |
| A4.5 | 测试搜索（文字搜索、风格搜索） | 测试报告 |

**预计时间**：0.5 天

---

## 三、阶段 B：搜索系统改造（下游）

**阶段目标**：利用高质量的商品标签，实现精准语义搜索

### 3.1 搜索流程总览

```
┌──────────────────────────────────────────────────────────────────────────┐
│                           用户输入                                        │
│                    "宽松休闲的女装牛仔裤"                                   │
└──────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                      阶段一：LLM 意图解析                                  │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │ 输出结构：                                                          │  │
│  │ {                                                                  │  │
│  │   "hardFilters": {                                                 │  │
│  │     "gender": "女装",           // 性别过滤条件                      │  │
│  │     "category": "牛仔裤"        // 品类过滤条件                      │  │
│  │   },                                                               │  │
│  │   "intentAnalysis": {                                              │  │
│  │     "attribute": "宽松、阔腿、休闲版型",                              │  │
│  │     "performance": "舒适、不紧绷、易搭配",                           │  │
│  │     "use": "日常休闲、逛街",                                        │  │
│  │     "style": "休闲风、简约"                                         │  │
│  │   }                                                                │  │
│  │ }                                                                  │  │
│  └────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                    阶段二：语义硬过滤（LLM 判断）                           │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │ 方式：LLM 向量语义匹配（非文本精确匹配）                               │  │
│  │                                                                    │  │
│  │ 用户意图 gender: "女装"                                             │  │
│  │ 商品 gender: "女士"  → LLM判断语义一致 → ✓ 通过                      │  │
│  │ 商品 gender: "女童"  → LLM判断语义不一致 → ✗ 排除                    │  │
│  │ 商品 gender: "淑女"  → LLM判断语义一致 → ✓ 通过                      │  │
│  │                                                                    │  │
│  │ 注：避免"女"字的简单文本匹配导致误判                                  │  │
│  └────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                    阶段三：APUS 向量语义搜索                               │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │ 五路并行向量搜索：                                                   │  │
│  │                                                                    │  │
│  │ 1. 综合向量搜索 (text_enhanced_embedding)                           │  │
│  │    用户增强搜索文本 ↔ 商品增强描述文本                                │  │
│  │                                                                    │  │
│  │ 2. 属性向量搜索 (attribute_embedding)                               │  │
│  │    用户属性意图 ↔ 商品属性关键词                                     │  │
│  │                                                                    │  │
│  │ 3. 性能向量搜索 (performance_embedding)                             │  │
│  │    用户性能意图 ↔ 商品性能关键词                                     │  │
│  │                                                                    │  │
│  │ 4. 场景向量搜索 (use_embedding)                                     │  │
│  │    用户场景意图 ↔ 商品场景关键词                                     │  │
│  │                                                                    │  │
│  │ 5. 风格向量搜索 (style_embedding)                                   │  │
│  │    用户风格意图 ↔ 商品风格关键词                                     │  │
│  └────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌──────────────────────────────────────────────────────────────────────────┐
│                      阶段四：加权排序                                      │
│  ┌────────────────────────────────────────────────────────────────────┐  │
│  │ 最终得分 =                                                          │  │
│  │   text_enhanced_score × 综合权重                                    │  │
│  │ + attribute_score × 属性权重                                        │  │
│  │ + performance_score × 性能权重                                      │  │
│  │ + use_score × 场景权重                                              │  │
│  │ + style_score × 风格权重                                            │  │
│  │                                                                    │  │
│  │ 权重总和 = 1.0                                                      │  │
│  └────────────────────────────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────────────────────────────┘
```

### 3.2 关键设计决策

| 决策点            | 方案选择                   | 原因                          |
| ----------------- | -------------------------- | ----------------------------- |
| 性别/品类过滤方式 | LLM 语义判断（非文本匹配） | 避免"女童"和"女装"的误匹配    |
| APUS 匹配方式     | 向量语义搜索               | 理解同义词                    |
| 向量模型          | `text-embedding-3-small` | 与现有 text_enhanced 保持一致 |
| 过滤时机          | 搜索前硬过滤               | 减少无效计算，提升性能        |

---

### B1: 数据库结构升级

**目标**：支持多维度向量搜索和性别过滤

**意义**：搜索需要多维度向量并行查询

#### B1.1 表结构变更清单

| 表名                             | 变更类型 | 字段                      | 类型             | 说明     |
| -------------------------------- | -------- | ------------------------- | ---------------- | -------- |
| `gg_taobao_product`            | 新增字段 | `gender`                | `text`         | 性别分类 |
| `gg_taobao_product_embeddings` | 新增字段 | `attribute_embedding`   | `vector(1536)` | 属性向量 |
| `gg_taobao_product_embeddings` | 新增字段 | `performance_embedding` | `vector(1536)` | 性能向量 |
| `gg_taobao_product_embeddings` | 新增字段 | `use_embedding`         | `vector(1536)` | 场景向量 |
| `gg_taobao_product_embeddings` | 新增字段 | `style_embedding`       | `vector(1536)` | 风格向量 |

#### B1.2 索引变更清单

| 表名                             | 索引类型 | 字段                      | 说明         |
| -------------------------------- | -------- | ------------------------- | ------------ |
| `gg_taobao_product`            | btree    | `gender`                | 性别过滤索引 |
| `gg_taobao_product_embeddings` | ivfflat  | `attribute_embedding`   | 属性向量索引 |
| `gg_taobao_product_embeddings` | ivfflat  | `performance_embedding` | 性能向量索引 |
| `gg_taobao_product_embeddings` | ivfflat  | `use_embedding`         | 场景向量索引 |
| `gg_taobao_product_embeddings` | ivfflat  | `style_embedding`       | 风格向量索引 |

#### B1.3 数据隔离说明

- 新数据使用 `gg_zara_*` 前缀的表，与原有 `gg_taobao_*` 表完全隔离
- 前端搜索时通过表名/source字段区分数据源
- 词典表 `gg_tag_dictionary` 可共用，也可按 source 区分

#### B1.4 实施清单

| 步骤 | 内容 | 产出 |
| ---- | ---- | ---- |
| B1.1 | 新增 `gender` 字段到商品表 | DDL 执行完成 |
| B1.2 | 新增 4 个 embedding 字段到向量表 | DDL 执行完成 |
| B1.3 | 创建必要索引 | 索引创建完成 |

**预计时间**：可与 A 阶段并行

---

### B2: 搜索 API 改造

**目标**：实现新的搜索流程（意图解析 → 语义硬过滤 → 多维度向量搜索 → 加权排序）

**意义**：
- 解决"女童"和"女装"被错误匹配的问题（语义判断而非文本匹配）
- APUS 匹配从关键词 → 向量语义，理解同义词

#### B2.1 语义硬过滤设计

##### 为什么不能用文本匹配

| 用户输入 | 商品标签 | 文本匹配结果    | 语义匹配结果        |
| -------- | -------- | --------------- | ------------------- |
| 女装     | 女士     | ❌ 不匹配       | ✅ 匹配             |
| 女装     | 女童     | ❌ 错误匹配"女" | ✅ 不匹配           |
| 女装     | 淑女风   | ❌ 不匹配       | ✅ 匹配             |
| 牛仔裤   | 牛仔短裤 | ❌ 模糊         | ✅ 匹配（同品类）   |
| 连衣裙   | 吊带裙   | ❌ 不匹配       | ✅ 匹配（裙装子类） |

##### 语义过滤实现方式

**方案**：使用向量相似度进行语义判断

```
用户 gender 意图: "女装"  → 向量化 → query_gender_vector
商品 gender 标签: "女士"  → 向量化 → product_gender_vector

相似度 = cosine_similarity(query_gender_vector, product_gender_vector)

if 相似度 > 阈值(0.8):
    通过过滤
else:
    排除
```

**阈值设定**：
- 性别过滤阈值：0.85（严格）
- 品类过滤阈值：0.75（允许子品类）

##### 性别分类体系

```
性别分类：
├── 女装
│   ├── 女士
│   ├── 女款
│   ├── 淑女
│   └── lady
├── 男装
│   ├── 男士
│   ├── 男款
│   └── gentleman
├── 童装
│   ├── 女童
│   ├── 男童
│   ├── 儿童
│   └── kids
└── 中性
    ├── 无性别标识
    └── 通用款
```

#### B2.2 搜索权重配置

##### 权重配置结构

```json
{
  "vectorWeights": {
    "text_enhanced": 0.3,    // 综合向量权重
    "attribute": 0.2,        // 属性向量权重
    "performance": 0.2,      // 性能向量权重
    "use": 0.15,             // 场景向量权重
    "style": 0.15            // 风格向量权重
  },
  "filterThresholds": {
    "gender": 0.85,          // 性别过滤阈值
    "category": 0.75         // 品类过滤阈值
  }
}
```

##### 权重约束

- `vectorWeights` 所有权重之和必须 = 1.0
- 所有权重值范围：0.0 ~ 1.0
- 阈值范围：0.5 ~ 1.0

#### B2.3 LLM 意图解析 Prompt

**【空缺】**：需要补充设计 LLM 意图解析的完整 Prompt，输出 hardFilters 和 intentAnalysis 结构。

#### B2.4 实施清单

| 步骤 | 内容 | 产出 |
| ---- | ---- | ---- |
| B2.1 | 修改 LLM Prompt，输出 hardFilters | Prompt 模板更新 |
| B2.2 | 实现语义硬过滤逻辑 | 过滤函数 |
| B2.3 | 实现 APUS 五路向量搜索 | 搜索函数 |
| B2.4 | 实现加权排序逻辑 | 排序函数 |

**预计时间**：需要 A4 完成后

---

### B3: 前端更新

**目标**：展示新的搜索结果和调试信息

**意义**：让用户和开发者能看清搜索过程，便于调优

#### B3.1 更新内容

**【空缺】**：需要补充前端 UI 的具体设计：
- 权重配置页面的 UI 设计
- Debug 信息展示的 UI 设计
- 各维度得分的展示方式

#### B3.2 实施清单

| 步骤 | 内容 | 产出 |
| ---- | ---- | ---- |
| B3.1 | 更新权重配置页面 | 新的权重配置 UI |
| B3.2 | 更新 Debug 信息展示 | 详细的各维度得分展示 |
| B3.3 | 集成测试 | 测试报告 |

**预计时间**：需要 B2 完成后

---

## 四、验收标准

### 4.1 功能验收

| 测试场景               | 预期结果                               |
| ---------------------- | -------------------------------------- |
| 搜索"女装连衣裙"       | 只返回女装，不返回童装/男装            |
| 搜索"宽松休闲的牛仔裤" | 只返回牛仔裤品类，不返回 T恤           |
| 搜索"凉快透气的裙子"   | 能匹配"透气面料"、"清凉"等语义相近商品 |
| 搜索"约会穿的连衣裙"   | 场景维度得分高的排在前面               |

### 4.2 技术验收

| 检查项         | 标准                                       |
| -------------- | ------------------------------------------ |
| 向量模型一致性 | 所有 embedding 使用 text-embedding-3-small |
| 向量维度       | 所有向量维度为 1536                        |
| 权重配置       | 可通过 UI 调整，实时生效                   |
| Debug 信息     | 显示各维度得分、过滤结果、最终排序         |

### 4.3 性能验收

| 指标         | 标准                  |
| ------------ | --------------------- |
| 搜索响应时间 | < 3 秒（含 LLM 解析） |
| 向量化时间   | 单商品 < 2 秒         |
| 过滤准确率   | 性别/品类过滤 > 95%   |

### 4.4 数据质量验收（阶段 A 专用）

| 指标 | 目标值 | 说明 |
|-----|-------|------|
| 分析成功率 | >= 95% | 通过 SQL 检查 |
| 风格多样性 | "百搭"占比 < 30% | v1 是 70%，这是核心改进 |
| 品类准确率 | >= 98% | 品类判断应该很准 |

---

## 五、关键风险与应对

| 风险             | 影响             | 应对措施                            |
| ---------------- | ---------------- | ----------------------------------- |
| 向量模型不一致   | 搜索结果完全不准 | 代码 Review 检查所有 embedding 调用 |
| 性别解析不准     | 过滤失效         | LLM Prompt 优化 + 人工抽检          |
| 语义阈值设置不当 | 过滤过严或过松   | 提供可配置阈值，支持调优            |
| 向量化脚本失败   | 数据不完整       | 增加重试机制和进度记录              |

---

## 六、附录

### 6.1 核心约束清单

#### 必须遵守的约束

| 约束项         | 说明                                               | 违反后果            |
| -------------- | -------------------------------------------------- | ------------------- |
| 向量模型一致性 | 所有 embedding 必须使用 `text-embedding-3-small` | 搜索结果完全错误    |
| 向量维度       | 必须为 1536                                        | 数据库存储/查询失败 |
| 性别必须解析   | 每个商品必须有 gender 字段                         | 性别过滤失效        |
| 品类必须解析   | 每个商品必须有 category 字段                       | 品类过滤失效        |
| 权重总和为 1   | vectorWeights 各项相加必须等于 1.0                 | 得分计算错误        |

#### 商品数据必须包含字段

- `gender` - 性别分类
- `category` - 品类分类
- `attribute_keywords` - 属性关键词数组
- `performance_keywords` - 性能关键词数组
- `use_keywords` - 场景关键词数组
- `style_keywords` - 风格关键词数组
- `text_enhanced` - 增强描述文本
- `text_enhanced_embedding` - 增强描述向量
- `attribute_embedding` - 属性向量
- `performance_embedding` - 性能向量
- `use_embedding` - 场景向量
- `style_embedding` - 风格向量

### 6.2 推荐 LLM 模型

| 模型 | 适用场景 | 成本 | 说明 |
|-----|---------|------|------|
| gpt-4o | 多模态分析 | ~$0.02/商品 | 视觉能力最强，首选 |
| claude-3.5-sonnet | 多模态分析 | ~$0.015/商品 | 备选 |
| gemini-2.0-flash | 词典生成 | ~$0.01/次 | 纯文本任务 |

### 6.3 成本估算（100 个商品）

| 阶段 | 调用次数 | 估算成本 |
|-----|---------|---------|
| 词典生成 | 1次 | ~$0.05 |
| 多模态分析 | 100次 | ~$2.00 |
| **总计** | | **~$2.05** |

### 6.4 时间估算

| 阶段 | 预计时间 |
|-----|---------|
| A1: 数据准备 | 0.5 天 |
| A2: 词典生成 | 0.5 天 |
| A3: 多模态商品分析 | 1 天 |
| A4: 向量化 | 0.5 天 |
| B1: 数据库结构升级 | 与 A 阶段并行 |
| B2: 搜索 API 改造 | 待定 |
| B3: 前端更新 | 待定 |
| **阶段 A 总计** | **约 2.5 天** |

### 6.5 后续优化方向

1. **品类层级结构**：建立品类树（服装 > 裙装 > 连衣裙 > 吊带连衣裙）
2. **属性关联图谱**：建立同义词/近义词映射
3. **用户反馈学习**：根据点击/购买调整权重
4. **多模态搜索**：支持图片搜索（以图搜图）
5. **互斥规则校验**（SQL 实现）
6. **蕴含规则校验**（SQL 实现）
7. **前端词典管理**：支持前端查看和维护词典
8. **多图分析**：利用多张图片提取更多信息
9. **专用模型**：数据积累后考虑微调

---

## 变更记录

| 版本 | 日期 | 变更内容 |
|-----|------|---------|
| v1.0 | 2025-12-12 | 合并商品标签生成方案v2 + 智能搜索优化方案，按阶段重新组织 |

---

**文档说明**：
- 本文档合并自《商品标签生成方案v2》和《ZARA智能搜索优化方案》
- 标注【空缺】的部分为原文档未涉及的内容，需后续补充设计
