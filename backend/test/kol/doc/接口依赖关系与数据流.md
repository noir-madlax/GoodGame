# 接口依赖关系与数据流分析

## 一、数据流总览

```
搜索关键词 → 搜索接口 → UID列表 → 星图KOL ID → 完整KOL数据
    ↓
["抖音 护肤达人 排行榜"]
    ↓
[3.1 fetch_general_search_result]
    ↓输出: user_list[]
        - uid (用户数字ID)
        - sec_uid (加密用户ID)
        - nickname (昵称)
        - follower_count (粉丝数)
        - ... (基础信息)
    ↓ 遍历每个 uid
[1.1 get_xingtu_kolid_by_uid]
    ↓输入: uid
    ↓输出: kol_id (星图KOL ID)
    ↓        如果不是星图KOL则返回null/error
    ↓ 如果是星图KOL，使用 kol_id 调用以下接口（可并行）
    ├─→ [1.2 kol_base_info_v1]
    │   ↓输入: kol_id
    │   ↓输出: 基础信息（昵称、粉丝、作品数、认证、擅长领域等）
    │
    ├─→ [1.3 kol_audience_portrait_v1]
    │   ↓输入: kol_id
    │   ↓输出: 受众画像（性别、年龄、地域、兴趣标签等）
    │
    ├─→ [1.4 kol_service_price_v1]
    │   ↓输入: kol_id
    │   ↓输出: 服务报价（视频、直播、图文报价、历史订单数）
    │
    ├─→ [1.5 kol_cp_info_v1]
    │   ↓输入: kol_id
    │   ↓输出: 内容定位（垂直领域、内容风格、合作案例）
    │
    └─→ [1.6 kol_conversion_ability_analysis_v1]
        ↓输入: kol_id
        ↓输出: 转化能力（转化率、互动数据、GMV能力）

(可选)如果需要作品级数据：
从搜索结果或用户主页获取 item_id (作品ID)
    ↓
    ├─→ [2.1 fetch_item_overview_data]
    │   ↓输入: item_id
    │   ↓输出: 作品数据概览（播放、点赞、评论、分享）
    │
    ├─→ [2.2 fetch_item_watch_trend]
    │   ↓输入: item_id, start_date, end_date
    │   ↓输出: 观看趋势曲线
    │
    ├─→ [2.3 fetch_item_danmaku_analysis]
    │   ↓输入: item_id
    │   ↓输出: 弹幕分析（热词、情感、高峰时刻）
    │
    └─→ [2.4 fetch_item_audience_portrait]
        ↓输入: item_id
        ↓输出: 作品受众画像
```

---

## 二、接口分类与输入输出

### 2.1 入口接口（不依赖其他接口）

#### 3.1 通用搜索

**接口**: `fetch_general_search_result`
**输入来源**:

- **keyword**: 用户输入的搜索关键词（如"抖音 护肤达人 排行榜"）
- **offset**: 分页偏移，默认0
- **count**: 返回数量，默认20
- **sort_type**: 排序方式（0=综合，1=最新，2=最热）

**输出字段（用户类型结果）**:

```json
{
  "uid": "123456789",           // → 用于 1.1 接口
  "sec_uid": "MS4wLjABAAAA...", // → 备用，某些接口也接受
  "nickname": "护肤小能手",
  "follower_count": 1500000,
  "total_favorited": 25000000,
  "signature": "专业护肤知识分享",
  "unique_id": "skincare_expert",
  "verification_type": 1
}
```

**输出字段（视频类型结果）**:

```json
{
  "aweme_id": "7505583378596646180", // → 用于 2.x 创作者接口
  "desc": "视频描述",
  "author": {
    "uid": "123456789",               // → 用于 1.1 接口
    "sec_uid": "MS4wLjABAAAA...",
    "nickname": "作者昵称"
  },
  "statistics": {
    "play_count": 2500000,
    "digg_count": 180000
  }
}
```

---

### 2.2 转换接口（依赖入口接口）

#### 1.1 获取星图KOL ID

**接口**: `get_xingtu_kolid_by_uid`
**输入来源**:

- **uid**: 从 `3.1 fetch_general_search_result` 的 user_info.uid 或 aweme_info.author.uid 获取

**输入获取方式**:

```python
# 从搜索结果的用户类型获取
uid = search_result["data"][i]["user_info"]["uid"]

# 或从视频结果的作者信息获取
uid = search_result["data"][i]["aweme_info"]["author"]["uid"]
```

**输出字段**:

```json
{
  "kol_id": "987654321",  // → 用于所有星图 1.2-1.6 接口
  "uid": "123456789"
}
```

**注意事项**:

- 非星图KOL会返回空或错误
- 需要先判断是否为星图KOL再调用后续接口

---

### 2.3 星图数据接口（依赖转换接口）

以下所有接口都依赖 `1.1` 接口获取的 `kol_id`，可以并行调用以提升效率。

#### 1.2 KOL基础信息

**输入来源**: `kol_id` 从 `1.1` 接口获取
**输出**: 用于生成KOL档案的基础数据

#### 1.3 KOL受众画像

**输入来源**: `kol_id` 从 `1.1` 接口获取
**输出**: 用于评估目标受众匹配度

#### 1.4 KOL服务报价

**输入来源**: `kol_id` 从 `1.1` 接口获取
**输出**: 用于商务合作预算评估

#### 1.5 KOL内容定位

**输入来源**: `kol_id` 从 `1.1` 接口获取
**输出**: 用于内容策略制定

#### 1.6 KOL转化能力分析

**输入来源**: `kol_id` 从 `1.1` 接口获取
**输出**: 用于ROI预估

---

### 2.4 作品级数据接口（可选，依赖作品ID）

这些接口需要创作者本人的登录态，第三方通常无法调用。

#### 2.1-2.4 创作者V2接口

**输入来源**:

- **item_id**: 从 `3.1` 搜索结果的 aweme_info.aweme_id 获取
- 或从用户主页爬取作品列表

**限制**:

- 需要创作者本人Cookie（我们没有这个放弃）
- 第三方调用会返回403

---

## 三、数据获取策略

### 3.1 完整调研流程（推荐）

#### 阶段1: 搜索与筛选

```python
# Step 1: 搜索达人
search_results = fetch_general_search_result(
    keyword="抖音 护肤达人 排行榜",
    count=50,
    sort_type=2  # 按热度排序
)

# Step 2: 筛选用户类型结果
users = [
    item["user_info"] 
    for item in search_results["data"] 
    if item["type"] == "user"
]

# Step 3: 按粉丝数排序，选择Top N
top_users = sorted(
    users, 
    key=lambda u: u.get("follower_count", 0), 
    reverse=True
)[:20]  # 取前20位达人
```

#### 阶段2: 转换为星图KOL

```python
kol_ids = []
for user in top_users:
    uid = user["uid"]
    try:
        kol_data = get_xingtu_kolid_by_uid(uid)
        if kol_data.get("kol_id"):
            kol_ids.append({
                "uid": uid,
                "kol_id": kol_data["kol_id"],
                "nickname": user["nickname"]
            })
    except Exception:
        # 不是星图KOL，跳过
        pass

print(f"找到 {len(kol_ids)} 位星图KOL")
```

#### 阶段3: 批量获取完整数据（并行）

```python
import concurrent.futures

def fetch_single_kol_complete_data(kol_info):
    """获取单个KOL的所有数据"""
    kol_id = kol_info["kol_id"]
  
    # 并行调用5个星图接口
    with concurrent.futures.ThreadPoolExecutor(max_workers=5) as executor:
        futures = {
            executor.submit(kol_base_info_v1, kol_id): "base_info",
            executor.submit(kol_audience_portrait_v1, kol_id): "audience",
            executor.submit(kol_service_price_v1, kol_id): "price",
            executor.submit(kol_cp_info_v1, kol_id): "cp_info",
            executor.submit(kol_conversion_ability_analysis_v1, kol_id): "conversion"
        }
      
        results = {"kol_id": kol_id, "nickname": kol_info["nickname"]}
        for future in concurrent.futures.as_completed(futures):
            data_type = futures[future]
            try:
                results[data_type] = future.result()
            except Exception as e:
                results[data_type] = {"error": str(e)}
  
    return results

# 批量获取（控制并发数为3，避免限流）
all_kol_data = []
with concurrent.futures.ThreadPoolExecutor(max_workers=3) as executor:
    future_to_kol = {
        executor.submit(fetch_single_kol_complete_data, kol): kol 
        for kol in kol_ids
    }
  
    for future in concurrent.futures.as_completed(future_to_kol):
        try:
            data = future.result()
            all_kol_data.append(data)
            # 保存每个KOL的数据
            save_kol_data(data)
        except Exception as e:
            print(f"Error: {e}")
```

---

### 3.2 简化流程（仅基础数据）

如果只需要基础信息，可以跳过星图接口直接使用搜索结果：

```python
# 搜索
search_results = fetch_general_search_result(keyword="护肤达人")

# 提取用户信息（搜索API返回的基础数据）
users = []
for item in search_results["data"]:
    if item["type"] == "user":
        users.append({
            "uid": item["user_info"]["uid"],
            "nickname": item["user_info"]["nickname"],
            "follower_count": item["user_info"]["follower_count"],
            "total_favorited": item["user_info"]["total_favorited"],
            "signature": item["user_info"]["signature"]
        })

# 不调用星图接口，数据已足够做初步筛选
```

---

## 四、接口输入数据获取方式总结表

| 接口           | 输入参数 | 从哪里获取        | 获取方法                                               |
| -------------- | -------- | ----------------- | ------------------------------------------------------ |
| 3.1 搜索       | keyword  | 用户输入/配置文件 | `input_file.read()`                                  |
| 1.1 获取KOL ID | uid      | 搜索结果          | `search_result["data"][i]["user_info"]["uid"]`       |
| 1.2 基础信息   | kol_id   | 1.1接口           | `get_xingtu_kolid_by_uid()` 返回值                   |
| 1.3 受众画像   | kol_id   | 1.1接口           | 同上                                                   |
| 1.4 服务报价   | kol_id   | 1.1接口           | 同上                                                   |
| 1.5 内容定位   | kol_id   | 1.1接口           | 同上                                                   |
| 1.6 转化能力   | kol_id   | 1.1接口           | 同上                                                   |
| 2.1 作品概览   | item_id  | 搜索结果/用户主页 | `search_result["data"][i]["aweme_info"]["aweme_id"]` |
| 2.2 观看趋势   | item_id  | 同上              | 同上                                                   |
| 2.3 弹幕分析   | item_id  | 同上              | 同上                                                   |
| 2.4 作品受众   | item_id  | 同上              | 同上                                                   |

---

## 五、Cookie需求矩阵

| 接口           | Cookie是否必需     | 无Cookie影响         | Cookie来源     |
| -------------- | ------------------ | -------------------- | -------------- |
| 3.1 搜索       | 可选               | 结果数量少、排名不准 | douyin.com登录 |
| 1.1 获取KOL ID | 推荐               | 可能失败             | douyin.com登录 |
| 1.2 基础信息   | 推荐               | 数据不全             | douyin.com登录 |
| 1.3 受众画像   | 必需               | 无法获取             | douyin.com登录 |
| 1.4 服务报价   | 必需               | 无法获取             | douyin.com登录 |
| 1.5 内容定位   | 必需               | 无法获取             | douyin.com登录 |
| 1.6 转化能力   | 必需               | 无法获取             | douyin.com登录 |
| 2.x 创作者接口 | 必需（创作者本人） | 403错误              | 创作者账号登录 |

**Cookie格式**: 见 `backend/test/kol/cookie` 文件

---

## 六、执行顺序优化建议

### 6.1 串行执行（稳妥但慢）

```
Step 1: 搜索 (1次请求)
    ↓ 等待1秒
Step 2: 逐个获取KOL ID (N次请求，每次间隔1秒)
    ↓
Step 3: 逐个获取星图数据 (N×5次请求，每个KOL间隔2秒)
```

**预估时间**: 对于20个KOL ≈ 20×(1+5×1) = 120秒 = 2分钟

### 6.2 半并行执行（推荐）

```
Step 1: 搜索 (1次请求)
    ↓
Step 2: 并行获取KOL ID (N次请求，并发数=5)
    ↓
Step 3: 逐个获取星图数据，但每个KOL内部并行 (N个KOL，每个5个接口并行)
```

**预估时间**: 对于20个KOL ≈ 1 + 4 + 20×2 = 45秒

### 6.3 全并行执行（快但风险高）

```
Step 1: 搜索 (1次请求)
    ↓
Step 2-3: 所有KOL所有接口全并行 (N×6次请求，并发数=10)
```

**预估时间**: 对于20个KOL ≈ 1 + (20×6)/10 = 13秒
**风险**: 容易触发限流

---

## 七、实际执行计划（本次任务）

基于用户需求 `@input` 文件内容："抖音 护肤达人 排行榜"

### 执行步骤:

1. **搜索阶段**:

   - 调用 `3.1 fetch_general_search_result`
   - keyword = "抖音 护肤达人 排行榜"
   - count = 50（获取更多结果便于筛选）
   - sort_type = 2（按热度排序）
2. **筛选阶段**:

   - 从搜索结果中提取 type="user" 的结果
   - 按粉丝数排序
   - 选择 Top 10-20 位达人
3. **转换阶段**:

   - 对每个 uid 调用 `1.1 get_xingtu_kolid_by_uid`
   - 筛选出星图KOL（有 kol_id 的）
   - 预估有 5-10 位是星图KOL
4. **详细数据获取阶段**:

   - 对每个星图KOL，并行调用 5 个星图接口
   - 保存每个接口的原始返回
   - 汇总为完整的KOL档案
5. **输出阶段**:

   - 每个接口的原始JSON保存到 `output/` 目录
   - 文件命名: `{接口名}_{kol_nickname}_{timestamp}.json`
   - 文件内包含输入参数，便于追踪

---

## 八、数据依赖检查清单

在调用接口前，确保满足以下条件：

### 3.1 搜索接口

- [ ] API_KEY 已设置
- [ ] keyword 已准备
- [ ] Cookie 已加载（可选但推荐）

### 1.1 获取KOL ID

- [ ] 已从搜索结果获取 uid
- [ ] uid 格式正确（纯数字字符串）
- [ ] API_KEY 已设置

### 1.2-1.6 星图接口

- [ ] 已获取有效的 kol_id
- [ ] Cookie 已加载（必需）
- [ ] Cookie 未过期
- [ ] API_KEY 已设置

### 2.1-2.4 创作者接口（本次不调用）

- [ ] 已获取 item_id
- [ ] 有创作者本人Cookie（通常不满足）

---

## 九、错误处理预案

| 错误场景       | 判断条件            | 处理方式                       |
| -------------- | ------------------- | ------------------------------ |
| 搜索无结果     | `data` 数组为空   | 更换关键词重试                 |
| UID不是星图KOL | `1.1` 返回空/错误 | 跳过该KOL，继续下一个          |
| Cookie过期     | `1.3-1.6` 返回403 | 提示更新Cookie                 |
| 速率限制       | 返回429             | 等待60秒后重试                 |
| 网络超时       | Timeout异常         | 重试3次                        |
| 部分接口失败   | 某个接口返回错误    | 记录错误，继续获取其他接口数据 |

---

**总结**: 本次任务的核心数据流为 `keyword → 搜索 → uid → kol_id → 星图数据`，关键是做好每一步的数据传递和错误处理。
